"use strict";(self.webpackChunk_jupyter_ai_core=self.webpackChunk_jupyter_ai_core||[]).push([[129],{81129:(e,t,n)=>{n.r(t),n.d(t,{default:()=>be});var l=n(70257),o=n(94083),r=n(56271),a=n.n(r),i=n(15777),s=n(53959),c=n(35048),u=n(13264),d=n(28504),m=n(28066),p=n(53626);function h(e){return getComputedStyle(document.body).getPropertyValue(e).trim()}function g(e){const[t,n]=(0,r.useState)((0,m.Z)());return(0,r.useEffect)((()=>{!async function(){n(await async function(){await async function(){for(;!document.body.hasAttribute("data-jp-theme-light");)await new Promise((e=>setTimeout(e,100)))}();const e=document.body.getAttribute("data-jp-theme-light"),t=h("--jp-ui-font-color1");return(0,m.Z)({spacing:4,components:{MuiButton:{defaultProps:{size:"small"}},MuiFilledInput:{defaultProps:{margin:"dense"}},MuiFormControl:{defaultProps:{margin:"dense",size:"small"}},MuiFormHelperText:{defaultProps:{margin:"dense"}},MuiIconButton:{defaultProps:{size:"small"}},MuiInputBase:{defaultProps:{margin:"dense",size:"small"}},MuiInputLabel:{defaultProps:{margin:"dense"}},MuiListItem:{defaultProps:{dense:!0}},MuiOutlinedInput:{defaultProps:{margin:"dense"}},MuiFab:{defaultProps:{size:"small"}},MuiTable:{defaultProps:{size:"small"}},MuiTextField:{defaultProps:{margin:"dense",size:"small"}},MuiToolbar:{defaultProps:{variant:"dense"}}},palette:{background:{paper:h("--jp-layout-color1"),default:h("--jp-layout-color1")},mode:"true"===e?"light":"dark",primary:{main:h("--jp-brand-color1"),light:h("--jp-brand-color2"),dark:h("--jp-brand-color0")},error:{main:h("--jp-error-color1"),light:h("--jp-error-color2"),dark:h("--jp-error-color0")},warning:{main:h("--jp-warn-color1"),light:h("--jp-warn-color2"),dark:h("--jp-warn-color0")},success:{main:h("--jp-success-color1"),light:h("--jp-success-color2"),dark:h("--jp-success-color0")},text:{primary:t,secondary:h("--jp-ui-font-color2"),disabled:h("--jp-ui-font-color3")}},shape:{borderRadius:2},typography:{fontFamily:h("--jp-ui-font-family"),fontSize:12,htmlFontSize:16,button:{textTransform:"capitalize"},allVariants:{color:t}}})}())}()}),[]),a().createElement(p.Z,{theme:t},e.children)}var f=n(30535),v=n.n(f),y=n(96707),E=n.n(y),b=n(40532),C=n.n(b),x=(n(38662),n(55351)),S=n(7464),w=n(6277);const k="jp-ai-code";function _({className:e,children:t,...n}){return a().createElement("code",Object.assign({},n,{className:(0,w.Z)(k,e)}),t)}var j;!function(e){e[e.None=0]="None",e[e.Copying=1]="Copying",e[e.Copied=2]="Copied"}(j||(j={}));const I={[j.None]:"Copy to clipboard",[j.Copying]:"Copying...",[j.Copied]:"Copied!"};function P({language:e,children:t,...n}){const l=(0,r.useMemo)((()=>String(t).replace(/\n$/,"")),[t]),[o,i]=(0,r.useState)(j.None);return a().createElement(c.Box,{sx:{display:"flex",flexDirection:"column"}},a().createElement(x.Prism,Object.assign({},n,{className:(0,w.Z)(n.className,k),children:l,style:S.Z,language:e,PreTag:"div"})),a().createElement(c.Button,{onClick:async()=>{i(j.Copying);try{await navigator.clipboard.writeText(l)}catch(e){return console.error(e),void i(j.None)}i(j.Copied),setTimeout((()=>i(j.None)),1e3)},disabled:o!==j.None,sx:{alignSelf:"flex-end"}},I[o]))}function M({inline:e,className:t,...n}){const l=/language-(\w+)/.exec(t||"");return e?a().createElement(_,Object.assign({},n)):a().createElement(P,Object.assign({},n,{language:l?l[1]:void 0}))}const A=a().createContext({});function L({globalAwareness:e,children:t}){const[n,l]=(0,r.useState)({});return(0,r.useEffect)((()=>{function t(){var t;const n=null!==(t=null==e?void 0:e.getStates())&&void 0!==t?t:new Map,o={};n.forEach((e=>{o[e.user.username]=e.user})),l(o)}return null==e||e.on("change",t),()=>{null==e||e.off("change",t)}}),[e]),e?a().createElement(A.Provider,{value:n},t):t}var T=n(64497);const F=new T.LabIcon({name:"jupyter-ai::chat",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px">\n  <g class="jp-icon3" fill="#616161">\n    <path d="M0 0h24v24H0V0z" fill="none"/>\n    <path d="M15 4v7H5.17L4 12.17V4h11m1-2H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1V3c0-.55-.45-1-1-1zm5 4h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1z"/>\n  </g>\n</svg>\n'}),B=new T.LabIcon({name:"jupyter-ai::jupyternaut",svgstr:'<svg viewBox="0 0 38 38" fill="none"\n    xmlns="http://www.w3.org/2000/svg">\n    <g clip-path="url(#clip0_0_2356)">\n        <rect width="38" height="38" fill="white" />\n        <circle cx="19" cy="19" r="19" fill="#F37726" />\n        <path fill-rule="evenodd" clip-rule="evenodd"\n            d="M19.9483 6.83653C20.5827 6.6205 21.0391 6.0196 21.0391 5.31212C21.0391 4.42296 20.3183 3.70215 19.4291 3.70215C18.5399 3.70215 17.8191 4.42296 17.8191 5.31212C17.8191 6.01951 18.2753 6.62033 18.9096 6.83644V8.00387H18.3702C12.0844 8.00387 6.97151 13.1171 6.97151 19.4026C6.97151 25.6885 12.0848 30.8013 18.3702 30.8013H19.7682C26.0541 30.8013 31.167 25.6881 31.167 19.4026C31.167 13.1773 26.1511 8.10183 19.9483 8.00527V6.83653ZM18.3702 29H19.7682C25.1351 29 29.4985 24.0213 29.4985 20.6545C29.4985 15.2876 25.1351 10.9242 19.7682 10.9242H18.3702C13.0034 10.9242 8.64 15.2876 8.64 20.6545C8.64 24.0213 13.0034 29 18.3702 29ZM32.8926 23.997C33.6267 23.997 33.6301 23.4847 33.6348 22.7562V22.7562V22.7562V22.7561C33.636 22.5714 33.6373 22.3728 33.6506 22.1651C33.7079 21.3027 33.7245 20.4643 33.7079 19.6759L33.7046 19.5569C33.6673 18.2251 33.661 17.999 32.3999 17.7511L32.252 17.7265L32.2535 17.776C32.2611 18.0225 32.2686 18.269 32.2686 18.515C32.2686 20.3168 31.9974 22.0628 31.4956 23.704C31.3593 24.1499 31.8389 24.5669 32.249 24.3451L32.8926 23.997ZM5.28037 23.997C4.54628 23.997 4.54296 23.4847 4.53822 22.7563C4.53702 22.5715 4.53573 22.3729 4.52241 22.1651C4.46511 21.3027 4.44849 20.4644 4.4651 19.6759L4.46846 19.557C4.50567 18.2251 4.51198 17.9991 5.77316 17.7512L5.921 17.7265L5.91949 17.776L5.91949 17.776C5.91193 18.0225 5.90438 18.269 5.90438 18.515C5.90438 20.3169 6.17557 22.0628 6.67738 23.704C6.81372 24.1499 6.33412 24.5669 5.92398 24.3451L5.28037 23.997ZM19.5225 11.9922C14.8928 11.9922 11.0449 14.9283 10.0641 18.7499C9.93031 19.2711 10.6154 19.4434 10.9411 19.0152C12.324 17.1972 14.0829 16.8622 15.6479 16.5641C17.7622 16.1614 19.5225 15.8262 19.5225 11.9922Z"\n            fill="white" />\n    </g>\n    <defs>\n        <clipPath id="clip0_0_2356">\n            <rect width="38" height="38" fill="white" />\n        </clipPath>\n    </defs>\n</svg>\n'}).react;function R(e){var t;const n=(0,r.useContext)(A),l={height:"24px",width:"24px"};let o;if("human"===e.message.type){const r=null===(t=null==n?void 0:n[e.message.client.username])||void 0===t?void 0:t.color;o=a().createElement(c.Avatar,{sx:{...l,...r&&{bgcolor:r}}},a().createElement(c.Typography,{sx:{fontSize:"var(--jp-ui-font-size1)",color:"var(--jp-ui-inverse-font-color1)"}},e.message.client.initials))}else o=a().createElement(c.Avatar,{sx:{...l,bgcolor:"var(--jp-jupyter-icon-color)"}},a().createElement(B,{display:"block",height:"100%",width:"100%"}));const i="human"===e.message.type?e.message.client.display_name:"Jupyternaut";return a().createElement(c.Box,{sx:{display:"flex",alignItems:"center","& > :not(:last-child)":{marginRight:3},...e.sx}},o,a().createElement(c.Box,{sx:{display:"flex",flexGrow:1,flexWrap:"wrap",justifyContent:"space-between",alignItems:"center"}},a().createElement(c.Typography,{sx:{fontWeight:700,color:"var(--jp-ui-font-color1)"}},i),a().createElement(c.Typography,{sx:{fontSize:"0.8em",color:"var(--jp-ui-font-color2)",fontWeight:300}},e.timestamp)))}function N(e){const[t,n]=(0,r.useState)({});function l(e){var t;return a().createElement("a",{href:null!==(t=e.href)&&void 0!==t?t:"#",target:"_blank",rel:"noopener noreferrer"},e.children)}return(0,r.useEffect)((()=>{const l={...t};let o=!1;for(const t of e.messages)t.id in l||(l[t.id]=new Date(1e3*t.time).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"}),o=!0);o&&n(l)}),[e.messages]),a().createElement(c.Box,{sx:{"& > :not(:last-child)":{borderBottom:"1px solid var(--jp-border-color2)"}}},e.messages.map(((e,n)=>a().createElement(c.Box,{key:n,sx:{padding:4}},a().createElement(R,{message:e,timestamp:t[e.id],sx:{marginBottom:3}}),a().createElement(v(),{className:"jp-RenderedHTMLCommon jp-ai-react-markdown",components:{a:l,code:M},remarkPlugins:[E()],rehypePlugins:[C()]},e.body)))))}var D=n(17380);function z(e){const t=e.sendWithShiftEnter?a().createElement("span",null,"Press ",a().createElement("b",null,"Shift"),"+",a().createElement("b",null,"Enter")," to send message"):a().createElement("span",null,"Press ",a().createElement("b",null,"Shift"),"+",a().createElement("b",null,"Enter")," to add a new line");return a().createElement(c.Box,{sx:e.sx},a().createElement(c.Box,{sx:{display:"flex"}},a().createElement(c.TextField,{value:e.value,onChange:t=>e.onChange(t.target.value),fullWidth:!0,variant:"outlined",multiline:!0,onKeyDown:function(t){"Enter"===t.key&&(e.sendWithShiftEnter&&t.shiftKey||!e.sendWithShiftEnter&&!t.shiftKey)&&(e.onSend(),t.stopPropagation(),t.preventDefault())},placeholder:"Ask Jupyternaut",InputProps:{endAdornment:a().createElement(c.InputAdornment,{position:"end"},a().createElement(c.IconButton,{size:"small",color:"primary",onClick:e.onSend,disabled:!e.value.trim().length,title:"Send message (SHIFT+ENTER)"},a().createElement(D.Z,null)))},FormHelperTextProps:{sx:{marginLeft:"auto",marginRight:0}},helperText:e.value.length>2?t:" "})),e.hasSelection&&a().createElement(c.FormGroup,{sx:{display:"flex",flexDirection:"row"}},a().createElement(c.FormControlLabel,{control:a().createElement(c.Checkbox,{checked:e.includeSelection,onChange:e.toggleIncludeSelection}),label:"Include selection"}),a().createElement(c.FormControlLabel,{control:a().createElement(c.Checkbox,{checked:e.replaceSelection,onChange:e.toggleReplaceSelection}),label:"Replace selection"})))}function W(e){return a().createElement(c.FormControl,{fullWidth:!0},a().createElement(c.InputLabel,null,e.label),a().createElement(c.Select,Object.assign({},e,{value:null===e.value?"null":e.value,label:e.label,onChange:(t,n)=>{var l;"null"===t.target.value&&(t.target.value=null),null===(l=e.onChange)||void 0===l||l.call(e,t,n)},MenuProps:{sx:{maxHeight:"50%",minHeight:400}}}),e.children))}var O,H,Z=n(7543),V=n(18957);async function J(e="",t={}){const n=V.ServerConnection.makeSettings(),l=Z.URLExt.join(n.baseUrl,"api/ai",e);let o;try{o=await V.ServerConnection.makeRequest(l,t,n)}catch(e){throw new V.ServerConnection.NetworkError(e)}let r=await o.text();if(r.length>0)try{r=JSON.parse(r)}catch(e){console.log("Not a JSON response body.",o)}if(!o.ok)throw new V.ServerConnection.ResponseError(o,r.message||r);return r}function K(e){var t;const[n,l]=(0,r.useState)(null),o=null===(t=e.values)||void 0===t?void 0:t[e.field.key];function i(t){if("format"in e.field){if("json"===e.field.format)try{JSON.parse(t.target.value),l(null)}catch(e){l("You must specify a value in JSON format.")}e.onChange({...e.values,[e.field.key]:t.target.value})}}return"integer"===e.field.type?a().createElement(c.TextField,{label:e.field.label,value:o,onChange:i,inputProps:{inputMode:"numeric",pattern:"[0-9]*"},fullWidth:!0}):"text"===e.field.type?a().createElement(c.TextField,{label:e.field.label,value:null!=o?o:"",onChange:i,error:!!n,helperText:null!=n?n:void 0,fullWidth:!0}):"text-multiline"===e.field.type?a().createElement(c.TextField,{label:e.field.label,value:null!=o?o:"",onChange:i,fullWidth:!0,multiline:!0,error:!!n,helperText:null!=n?n:void 0,minRows:2}):a().createElement(a().Fragment,null)}function $(e){var t;return(null===(t=e.fields)||void 0===t?void 0:t.length)?a().createElement(a().Fragment,null,e.fields.map(((t,n)=>a().createElement(K,Object.assign({},e,{field:t,key:n,values:e.values,onChange:e.onChange}))))):null}function G(e,t){const n=function(e){if(!e)return null;const t=e.split(":");return t.length<2?null:t[0]}(e),l=t.providers.find((e=>e.id===n));return null!=l?l:null}!function(e){e.getConfig=async function(){return J("config")},e.listLmProviders=async function(){return J("providers")},e.listEmProviders=async function(){return J("providers/embeddings")},e.updateConfig=async function(e){return J("config",{method:"POST",body:JSON.stringify(e)})},e.deleteApiKey=async function(e){return J(`api_keys/${e}`,{method:"DELETE"})}}(O||(O={})),function(e){e[e.Loading=0]="Loading",e[e.Error=1]="Error",e[e.Ready=2]="Ready"}(H||(H={}));var U=n(97705);const Y=(0,c.styled)((({className:e,...t})=>a().createElement(c.Tooltip,Object.assign({},t,{arrow:!0,classes:{popper:e}}))))((({theme:e})=>({[`& .${c.tooltipClasses.tooltip}`]:{backgroundColor:e.palette.common.black,color:e.palette.common.white,boxShadow:e.shadows[1],fontSize:11},[`& .${c.tooltipClasses.arrow}`]:{color:e.palette.common.black}})));function Q(e){const[t,n]=(0,r.useState)(!1),[l,o]=(0,r.useState)(!1),i=(0,r.useMemo)((()=>!!e.confirm),[]);return a().createElement(c.Box,{sx:{position:"relative",display:"inline-block",boxSizing:"content-box"}},a().createElement(Y,{title:"Click again to confirm",open:l,onClose:()=>o(!1),arrow:!0,placement:"top"},a().createElement(c.IconButton,{disabled:t,onClick:async function(){if(i&&!l)return void o(!0);n(!0);let t=!1;try{await e.onClick()}catch(n){t=!0,n instanceof Error?e.onError(n.toString()):e.onError("Unknown error occurred.")}n(!1),t||e.onSuccess()},onMouseDown:e.onMouseDown},e.children)),t&&a().createElement(c.CircularProgress,{size:"100%",sx:{position:"absolute",top:0,left:0}}))}function q(e){const[t,n]=(0,r.useState)(null);return a().createElement(c.Box,{sx:{"& > .MuiBox-root:not(:first-child)":{marginTop:-2}}},e.apiKeys.map((l=>a().createElement(X,{key:l,alert:e.alert,apiKey:l,editable:t===l,setEditable:n,onSuccess:e.onSuccess}))),e.alert.jsx)}function X(e){const[t,n]=(0,r.useState)(""),[l,o]=(0,r.useState)(!1),[i,s]=(0,r.useState)(!1),u=(0,r.useRef)();(0,r.useEffect)((()=>{var t;e.editable?null===(t=u.current)||void 0===t||t.focus():(n(""),o(!1),s(!1))}),[e.editable]);const d=(0,r.useCallback)((()=>{e.setEditable(e.apiKey)}),[]),m=(0,r.useCallback)((()=>O.deleteApiKey(e.apiKey)),[]),p=(0,r.useCallback)((()=>{o((e=>!e))}),[]),h=(0,r.useCallback)((()=>{e.setEditable(null)}),[]),g=(0,r.useCallback)((()=>O.updateConfig({api_keys:{[e.apiKey]:t}})),[t]),f=(0,r.useCallback)((t=>{e.alert.show("error",t)}),[e.alert]),v=(0,r.useCallback)((()=>{e.editable&&s(!t)}),[e.editable,t]),y=(0,r.useCallback)((()=>{e.setEditable(null),e.alert.show("success","API key updated successfully."),e.onSuccess()}),[e.alert,e.onSuccess]),E=(0,r.useCallback)((()=>{e.alert.show("success","API key deleted successfully."),e.onSuccess()}),[e.alert,e.onSuccess]);return a().createElement(c.Box,{sx:{display:"flex",alignItems:"flex-start"}},a().createElement(c.TextField,{value:t,onChange:e=>n(e.target.value),disabled:!e.editable,inputRef:u,onBlur:v,error:i,helperText:"API key value must not be empty",FormHelperTextProps:{sx:{visibility:i?"unset":"hidden",margin:0,whiteSpace:"nowrap"}},size:"small",variant:"standard",type:l?"text":"password",label:a().createElement(c.Typography,null,a().createElement("pre",{style:{margin:0}},e.apiKey)),InputProps:{endAdornment:e.editable&&a().createElement(c.InputAdornment,{position:"end"},a().createElement(c.IconButton,{onClick:p,edge:"end",onMouseDown:e=>e.preventDefault()},l?a().createElement(U.VisibilityOff,null):a().createElement(U.Visibility,null)))},sx:{flexGrow:1,margin:0,"& .MuiInputBase-input":{padding:0,paddingBottom:1}}}),a().createElement(c.Box,{sx:{marginTop:"11px",marginLeft:2,whiteSpace:"nowrap"}},e.editable?a().createElement(a().Fragment,null,a().createElement(c.IconButton,{onClick:h,onMouseDown:e=>e.preventDefault()},a().createElement(U.Cancel,null)),a().createElement(Q,{onClick:g,onError:f,onSuccess:y,onMouseDown:e=>e.preventDefault(),confirm:!0},a().createElement(U.Check,{color:"success"}))):a().createElement(a().Fragment,null,a().createElement(c.IconButton,{onClick:d},a().createElement(U.Edit,null)),a().createElement(Q,{onClick:m,onError:f,onSuccess:E,confirm:!0},a().createElement(U.DeleteOutline,{color:"error"})))))}function ee(e,t){return te(e,t)}function te(e,t){var n;const l={};for(const o in t){if(!(o in e)||typeof e[o]!=typeof t[o]){l[o]=t[o];continue}const r=e[o],a=t[o];if(Array.isArray(r)&&Array.isArray(a))(r.length!==a.length||!r.every(((e,t)=>e===a[t])))&&(l[o]=a);else if("object"==typeof a){const e=te(r,a);(null===(n=Object.keys(e))||void 0===n?void 0:n.length)&&(l[o]=e)}else r!==a&&(l[o]=a)}return l}function ne(){const[e,t]=(0,r.useState)(null),[n,l]=(0,r.useState)(""),[o,i]=(0,r.useState)(0),[s,u]=(0,r.useState)(!1),[d,m]=(0,r.useState)(),[p,h]=(0,r.useState)();return{show:(0,r.useCallback)(((o,r)=>{const a=r.toString();o!==e||a!==n?(null===e&&m(new Promise((e=>{h((()=>e))}))),t(o),l(a),i(0),u(!0)):i((e=>e+1))}),[n,e]),jsx:(0,r.useMemo)((()=>a().createElement(c.Collapse,{in:s,onExited:()=>{null==p||p(),t(null),l(""),i(0)},timeout:200},null!==e&&a().createElement(c.Alert,{severity:e},n+(o?` (${o})`:"")))),[n,o,e,s,p]),clear:(0,r.useCallback)((()=>(u(!1),d)),[s,d])}}function le(){const e=function(){const[e,t]=(0,r.useState)(H.Loading),[n,l]=(0,r.useState)(),[o,a]=(0,r.useState)(""),i=(0,r.useCallback)((async()=>{try{const[e,n,o]=await Promise.all([O.getConfig(),O.listLmProviders(),O.listEmProviders()]),r=e.model_provider_id,a=e.embeddings_provider_id,i=null===r?null:G(r,n),s=null===a?null:G(a,o),c=null===r?"":function(e){const t=e.split(":");return t.length<2?"":t[1]}(r);l({config:e,lmProviders:n,emProviders:o,lmProvider:i,emProvider:s,lmLocalId:c}),t(H.Ready)}catch(e){console.error(e),e instanceof Error?a(e.toString()):a("An unknown error occurred."),t(H.Error)}}),[]),s=(0,r.useCallback)((async()=>{if(!n)return;const e=await O.getConfig();l({...n,config:{...n.config,api_keys:e.api_keys,last_read:e.last_read}})}),[n]);return(0,r.useEffect)((()=>{i()}),[]),(0,r.useMemo)((()=>e===H.Loading?{state:e}:e!==H.Error&&n?{state:e,...n,refetchAll:i,refetchApiKeys:s}:{state:H.Error,error:o}),[e,n,o,s])}(),t=ne(),n=ne(),[l,o]=(0,r.useState)(null),[i,u]=(0,r.useState)(!1),[d,m]=(0,r.useState)(null),[p,h]=(0,r.useState)(""),g=(0,r.useMemo)((()=>l?l.id+":"+p:null),[l,p]),[f,y]=(0,r.useState)(null),E=(0,r.useMemo)((()=>null===f||e.state!==H.Ready?null:oe(f,e.emProviders)),[f,e]),[b,C]=(0,r.useState)({}),[x,S]=(0,r.useState)(!1),[w,k]=(0,r.useState)({}),[_,j]=(0,r.useState)(!1);return(0,r.useEffect)((()=>{var t,n,l;e.state===H.Ready&&(h(e.lmLocalId),y(e.config.embeddings_provider_id),S(e.config.send_with_shift_enter),m(null!==(n=null===(t=e.lmProvider)||void 0===t?void 0:t.help)&&void 0!==n?n:null),(null===(l=e.lmProvider)||void 0===l?void 0:l.registry)&&u(!0),o(e.lmProvider))}),[e]),(0,r.useEffect)((()=>{if(e.state!==H.Ready)return;const t={},n=null==l?void 0:l.auth_strategy,o=null==E?void 0:E.auth_strategy;"env"!==(null==n?void 0:n.type)||e.config.api_keys.includes(n.name)||(t[n.name]=""),"multienv"===(null==n?void 0:n.type)&&n.names.forEach((n=>{e.config.api_keys.includes(n)||(t[n]="")})),"env"!==(null==o?void 0:o.type)||e.config.api_keys.includes(o.name)||(t[o.name]=""),"multienv"===(null==o?void 0:o.type)&&o.names.forEach((n=>{e.config.api_keys.includes(n)||(t[n]="")})),C(t)}),[l,E,e]),(0,r.useEffect)((()=>{var t,n;if(e.state!==H.Ready||!g)return;const l=null!==(n=null===(t=e.config.fields)||void 0===t?void 0:t[g])&&void 0!==n?n:{};k(l)}),[e,l]),e.state===H.Loading?a().createElement(s.Z,{sx:{width:"100%",height:"100%",boxSizing:"border-box",display:"flex",alignItems:"center",justifyContent:"space-around"}},a().createElement(c.CircularProgress,null)):e.state===H.Error?a().createElement(s.Z,{sx:{width:"100%",height:"100%",padding:4,boxSizing:"border-box"}},a().createElement(c.Alert,{severity:"error"},e.error||"An unknown error occurred. Check the console for more details.")):a().createElement(s.Z,{sx:{padding:"0 12px 12px",boxSizing:"border-box","& .MuiAlert-root":{marginTop:2},overflowY:"auto"}},a().createElement("h2",{className:"jp-ai-ChatSettings-header"},"Language model"),a().createElement(W,{value:(null==l?void 0:l.registry)?l.id+":*":g,label:"Language model",onChange:t=>{var n;const l="null"===t.target.value?null:t.target.value;if(null===l)return void o(null);const r=oe(l,e.lmProviders),a=function(e){if(!e)return null;const t=e.split(":");return t[t.length-1]}(l);o(r),m(null!==(n=null==r?void 0:r.help)&&void 0!==n?n:null),r.registry?(h(""),u(!0)):(h(a),u(!1))},MenuProps:{sx:{maxHeight:"50%",minHeight:400}}},a().createElement(c.MenuItem,{value:"null"},"None"),e.lmProviders.providers.map((e=>e.models.map((t=>a().createElement(c.MenuItem,{value:`${e.id}:${t}`},e.name," :: ",t)))))),i&&a().createElement(c.TextField,{label:(null==l?void 0:l.model_id_label)||"Local model ID",value:p,onChange:e=>h(e.target.value),fullWidth:!0}),d&&a().createElement(c.Typography,{className:"jp-ai-ChatSettings-model-help"},a().createElement(v(),{linkTarget:"_blank"},d)),g&&a().createElement($,{fields:null==l?void 0:l.fields,values:w,onChange:k}),a().createElement("h2",{className:"jp-ai-ChatSettings-header"},"Embedding model"),a().createElement(W,{value:f,label:"Embedding model",onChange:e=>{const t="null"===e.target.value?null:e.target.value;y(t)},MenuProps:{sx:{maxHeight:"50%",minHeight:400}}},a().createElement(c.MenuItem,{value:"null"},"None"),e.emProviders.providers.map((e=>e.models.filter((e=>"*"!==e)).map((t=>a().createElement(c.MenuItem,{value:`${e.id}:${t}`},e.name," :: ",t)))))),a().createElement("h2",{className:"jp-ai-ChatSettings-header"},"API Keys"),Object.entries(b).map((([e,t],n)=>a().createElement(c.TextField,{key:n,label:e,value:t,fullWidth:!0,type:"password",onChange:t=>C((n=>({...n,[e]:t.target.value})))}))),a().createElement(q,{alert:n,apiKeys:e.config.api_keys,onSuccess:e.refetchApiKeys}),a().createElement("h2",{className:"jp-ai-ChatSettings-header"},"Input"),a().createElement(c.FormControl,null,a().createElement(c.FormLabel,{id:"send-radio-buttons-group-label"},"When writing a message, press ",a().createElement("kbd",null,"Enter")," to:"),a().createElement(c.RadioGroup,{"aria-labelledby":"send-radio-buttons-group-label",value:x?"newline":"send",name:"send-radio-buttons-group",onChange:e=>{S("newline"===e.target.value)}},a().createElement(c.FormControlLabel,{value:"send",control:a().createElement(c.Radio,null),label:"Send the message"}),a().createElement(c.FormControlLabel,{value:"newline",control:a().createElement(c.Radio,null),label:a().createElement(a().Fragment,null,"Start a new line (use ",a().createElement("kbd",null,"Shift"),"+",a().createElement("kbd",null,"Enter")," to send)")}))),a().createElement(s.Z,{sx:{display:"flex",justifyContent:"flex-end"}},a().createElement(c.Button,{variant:"contained",onClick:async()=>{if(e.state!==H.Ready)return;for(const e in w){const t=w[e];if("string"==typeof t&&t.trim().startsWith("{"))try{const n=JSON.parse(t),l=JSON.stringify(n);w[e]=l}catch(e){continue}}let l={model_provider_id:g,embeddings_provider_id:f,api_keys:b,...g&&{fields:{[g]:w}},send_with_shift_enter:x};l=ee(e.config,l),l.last_read=e.config.last_read,j(!0);try{await n.clear(),await O.updateConfig(l)}catch(e){console.error(e);const n=e instanceof Error||"string"==typeof e?e.toString():"An unknown error occurred. Check the console for more details.";return void t.show("error",n)}finally{j(!1)}await e.refetchAll(),t.show("success","Settings saved successfully.")},disabled:_},_?"Saving...":"Save changes")),t.jsx)}function oe(e,t){const n=function(e){return e?e.split(":")[0]:null}(e),l=t.providers.find((e=>e.id===n));return null!=l?l:null}const re=a().createContext([null,()=>{}]);function ae({selectionWatcher:e,children:t}){const[n,l]=(0,r.useState)(null);(0,r.useEffect)((()=>{e.selectionChanged.connect(((e,t)=>{l(t)}))}),[]);const o=(0,r.useCallback)((t=>{e.replaceSelection(t)}),[e]);return a().createElement(re.Provider,{value:[n,o]},t)}function ie(e){const t=(0,r.useMemo)((()=>"jupyter-ai-scroll-container-"+Date.now().toString()),[]);return(0,r.useEffect)((()=>{const e=document.querySelector(`#${t}`);if(!e)return;const n=new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting&&e.scroll({top:999999999})}))}),{threshold:1});return n.observe(e),()=>n.disconnect()}),[]),a().createElement(c.Box,{id:t,sx:{overflowY:"scroll","& *":{overflowAnchor:"none"},...e.sx}},a().createElement(c.Box,{sx:{minHeight:"100.01%"}},e.children),a().createElement(c.Box,{sx:{overflowAnchor:"auto",height:"1px"}}))}function se({chatHandler:e,setChatView:t}){const[n,l]=(0,r.useState)([]),[o,i]=(0,r.useState)(!1),[d,m]=(0,r.useState)(!0),[p,h]=(0,r.useState)(!1),[g,f]=(0,r.useState)(""),[v,y]=(0,r.useContext)(re),[E,b]=(0,r.useState)(!0);return(0,r.useEffect)((()=>{!async function(){var t;try{const[n,o]=await Promise.all([e.getHistory(),O.getConfig()]);b(null!==(t=o.send_with_shift_enter)&&void 0!==t&&t),l(n.messages),o.model_provider_id||i(!0)}catch(e){console.error(e)}}()}),[e]),(0,r.useEffect)((()=>{function t(e){"connection"!==e.type&&("clear"!==e.type?l((t=>[...t,e])):l([]))}return e.addListener(t),function(){e.removeListener(t)}}),[e]),o?a().createElement(s.Z,{sx:{padding:4,display:"flex",flexGrow:1,alignItems:"top",justifyContent:"space-around"}},a().createElement(c.Stack,{spacing:4},a().createElement("p",{className:"jp-ai-ChatSettings-welcome"},"Welcome to Jupyter AI! To get started, please select a language model to chat with from the settings panel. You may also need to provide API credentials, so have those handy."),a().createElement(c.Button,{variant:"contained",startIcon:a().createElement(u.Z,null),size:"large",onClick:()=>(i(!1),void t(ce.Settings))},"Start Here"))):a().createElement(a().Fragment,null,a().createElement(ie,{sx:{flexGrow:1}},a().createElement(N,{messages:n})),a().createElement(z,{value:g,onChange:f,onSend:async()=>{f("");const t=g+(d&&(null==v?void 0:v.text)?"\n\n```\n"+v.text+"\n```":""),n=await e.sendMessage({prompt:t}),l=await e.replyFor(n);if(p&&v){const{cellId:e,...t}=v;y({...t,...e&&{cellId:e},text:l.body})}},hasSelection:!!(null==v?void 0:v.text),includeSelection:d,toggleIncludeSelection:()=>m((e=>!e)),replaceSelection:p,toggleReplaceSelection:()=>h((e=>!e)),sx:{paddingLeft:4,paddingRight:4,paddingTop:3.5,paddingBottom:0,borderTop:"1px solid var(--jp-border-color1)"},sendWithShiftEnter:E}))}var ce;function ue(e){const[t,n]=(0,r.useState)(e.chatView||ce.Chat);return a().createElement(g,null,a().createElement(ae,{selectionWatcher:e.selectionWatcher},a().createElement(L,{globalAwareness:e.globalAwareness},a().createElement(s.Z,{sx:{width:"100%",height:"100%",boxSizing:"border-box",background:"var(--jp-layout-color0)",display:"flex",flexDirection:"column"}},a().createElement(s.Z,{sx:{display:"flex",justifyContent:"space-between"}},t!==ce.Chat?a().createElement(c.IconButton,{onClick:()=>n(ce.Chat)},a().createElement(d.Z,null)):a().createElement(s.Z,null),t===ce.Chat?a().createElement(c.IconButton,{onClick:()=>n(ce.Settings)},a().createElement(u.Z,null)):a().createElement(s.Z,null)),t===ce.Chat&&a().createElement(se,{chatHandler:e.chatHandler,setChatView:n}),t===ce.Settings&&a().createElement(le,null)))))}!function(e){e[e.Chat=0]="Chat",e[e.Settings=1]="Settings"}(ce||(ce={}));var de=n(62935),me=n(22877),pe=n(48598),he=n(77423),ge=n(78918),fe=n(71840);function ve(e){var t;if(!(e instanceof de.DocumentWidget))return null;let n;const{content:l}=e;return l instanceof pe.FileEditor?n=l.editor:l instanceof he.Notebook&&(n=null===(t=l.activeCell)||void 0===t?void 0:t.editor),n instanceof me.CodeMirrorEditor?n:void 0}class ye{constructor(e){if(this._mainAreaWidget=null,this._selection=null,this._selectionChanged=new fe.Signal(this),!(e instanceof l.LabShell))throw"Shell is not an instance of LabShell. Jupyter AI does not currently support custom shells.";this._shell=e,this._shell.currentChanged.connect(((e,t)=>{this._mainAreaWidget=t.newValue})),setInterval(this._poll.bind(this),200)}get selectionChanged(){return this._selectionChanged}replaceSelection(e){const t=(0,ge.find)(this._shell.widgets(),(t=>t.id===e.widgetId));if(!(t instanceof de.DocumentWidget))return;if(this._shell.activateById(e.widgetId),t.content instanceof he.Notebook&&e.cellId){const n=function(e,t){var n;const l=null===(n=e.model)||void 0===n?void 0:n.sharedModel.cells.findIndex((e=>e.getId()===t));return void 0===l?-1:l}(t.content,e.cellId);-1!==n&&(t.content.activeCellIndex=n)}const n=ve(t);if(!n)return;n.model.sharedModel.updateSource(n.getOffsetAt(e.start),n.getOffsetAt(e.end),e.text);const l=n.getPositionAt(n.getOffsetAt(e.start)+e.text.length);n.setSelection({start:l,end:l})}_poll(){const e=this._selection,t=function(e){var t;const n=ve(e);if(!(n&&e instanceof de.DocumentWidget))return null;let l;e.content instanceof he.Notebook&&(l=null===(t=e.content.activeCell)||void 0===t?void 0:t.model.id);const o=n.getSelection();let{start:r,end:a}=o;const i=n.getOffsetAt(r),s=n.getOffsetAt(a),c=n.model.sharedModel.getSource().substring(i,s);return c?(i>s&&([r,a]=[a,r]),{...o,start:r,end:a,text:c,widgetId:e.id,...l&&{cellId:l}}):null}(this._mainAreaWidget);(null==e?void 0:e.text)!==(null==t?void 0:t.text)&&(this._selection=t,this._selectionChanged.emit(t))}}class Ee{constructor(e={}){var t;this.id="",this._sendResolverQueue=[],this._replyForResolverDict={},this._isDisposed=!1,this._socket=null,this._listeners=[],this.serverSettings=null!==(t=e.serverSettings)&&void 0!==t?t:V.ServerConnection.makeSettings()}async initialize(){await this._initialize()}sendMessage(e){return new Promise((t=>{var n;null===(n=this._socket)||void 0===n||n.send(JSON.stringify(e)),this._sendResolverQueue.push(t)}))}replyFor(e){return new Promise((t=>{this._replyForResolverDict[e]=t}))}addListener(e){this._listeners.push(e)}removeListener(e){const t=this._listeners.indexOf(e);t>-1&&this._listeners.splice(t,1)}async getHistory(){let e={messages:[]};try{e=await J("chats/history",{method:"GET"})}catch(e){return Promise.reject(e)}return e}get isDisposed(){return this._isDisposed}dispose(){if(this.isDisposed)return;this._isDisposed=!0,this._listeners=[];const e=this._socket;e&&(this._socket=null,e.onopen=()=>{},e.onerror=()=>{},e.onmessage=()=>{},e.onclose=()=>{},e.close())}_onMessage(e){var t;"human"===e.type&&e.client.id===this.id&&(null===(t=this._sendResolverQueue.shift())||void 0===t||t(e.id)),"agent"===e.type&&e.reply_to in this._replyForResolverDict&&(this._replyForResolverDict[e.reply_to](e),delete this._replyForResolverDict[e.reply_to]),this._listeners.forEach((t=>t(e)))}_onClose(e,t){if(t(new Error("Chat UI websocket disconnected")),console.error("Chat UI websocket disconnected"),1006===e.code){const e=1;console.info(`Will try to reconnect in ${e} s.`),setTimeout((async()=>await this._initialize()),1e3*e)}}_initialize(){return new Promise(((e,t)=>{if(this.isDisposed)return;console.log("Creating a new websocket connection for chat...");const{token:n,WebSocket:l,wsUrl:o}=this.serverSettings,r=Z.URLExt.join(o,"api/ai/chats")+(n?`?token=${encodeURIComponent(n)}`:""),a=this._socket=new l(r);a.onclose=e=>this._onClose(e,t),a.onerror=e=>t(e),a.onmessage=e=>e.data&&this._onMessage(JSON.parse(e.data));const i=t=>{"connection"===t.type&&(this.id=t.client_id,e(),this.removeListener(i))};this.addListener(i)}))}}const be={id:"jupyter_ai:plugin",autoStart:!0,optional:[o.IGlobalAwareness,l.ILayoutRestorer],activate:async(e,t,n)=>{const l=new ye(e.shell),o=new Ee;let r=null;try{await o.initialize(),r=function(e,t,n){const l=i.ReactWidget.create(a().createElement(ue,{selectionWatcher:e,chatHandler:t,globalAwareness:n}));return l.id="jupyter-ai::chat",l.title.icon=F,l.title.caption="Jupyter AI Chat",l}(l,o,t)}catch(e){r=function(){const e=i.ReactWidget.create(a().createElement(g,null,a().createElement(c.Box,{sx:{width:"100%",height:"100%",boxSizing:"border-box",background:"var(--jp-layout-color0)",display:"flex",flexDirection:"column"}},a().createElement(c.Box,{sx:{padding:4}},a().createElement(c.Alert,{severity:"error"},"There seems to be a problem with the Chat backend, please look at the JupyterLab server logs or contact your administrator to correct this problem.")))));return e.id="jupyter-ai::chat",e.title.icon=F,e.title.caption="Jupyter AI Chat",e}()}e.shell.add(r,"left",{rank:2e3}),n&&n.add(r,"jupyter-ai-chat")}}}}]);