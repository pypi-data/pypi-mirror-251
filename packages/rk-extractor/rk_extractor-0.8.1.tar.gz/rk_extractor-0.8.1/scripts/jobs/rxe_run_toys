#!/usr/bin/env bash

#--------------------------------------
set_paths()
{
    if   [[   -z $RK_TOY ]];then
        VENV=$PWD/RK_TOY
	INSTALL=1
    elif [[ ! -d $RK_TOY ]];then
        VENV=$RK_TOY
	INSTALL=1
    elif [[   -d $RK_TOY ]];then
        VENV=$RK_TOY
	INSTALL=0
    fi

    PYTHONPATH+=:$VENV/lib/python3.9/site-packages
    source /cvmfs/sft.cern.ch/lcg/views/dev3/latest/x86_64-centos7-gcc12-opt/setup.sh
}
#--------------------------------------
install_sft()
{
    if [[ $INSTALL -eq 0 ]];then
	return
    fi

    mkdir -p $VENV

    pip install                   --prefix $VENV logzero 
    pip install                   --prefix $VENV rx_selection
    pip install --no-dependencies --prefix $VENV rx-differential-crosscheck-fits
    pip install --no-dependencies --prefix $VENV rk-hadmisid-study
    pip install --no-dependencies --prefix $VENV rx_monitor
    pip install --no-dependencies --prefix $VENV rx_hqm
    pip install --no-dependencies --prefix $VENV rx_combinatorial 
    pip install --no-dependencies --prefix $VENV rx_scripts
    pip install --no-dependencies --prefix $VENV rx_tools
    pip install --no-dependencies --prefix $VENV rk_extractor
}
#--------------------------------------
prepare()
{
    export HQMDIR=/publicfs/ucas/user/qi/public/RK/high_q2_yield_study
    for TARBALL in `ls *.tar.gz`;do
	tar -xf $TARBALL
    done
}
#--------------------------------------
run()
{
    echo "--------------------"
    echo "Running rxe_run_toys with args: $DSET, $VARF, $MODS"
    ./rxe_toys -d $DSET -v $VARF -m $MODS
    echo "--------------------"
}
#--------------------------------------
DSET="$1"
VARF="$2"
MODS="$3"
set_paths
install_sft
prepare
run

