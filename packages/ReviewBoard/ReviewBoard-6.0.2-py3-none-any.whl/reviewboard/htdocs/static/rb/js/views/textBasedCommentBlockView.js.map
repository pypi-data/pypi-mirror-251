{"version":3,"file":"textBasedCommentBlockView.js","names":["RB","TextBasedCommentBlockView","AbstractCommentBlockView","extend","tagName","className","template","_","initialize","$beginRow","$endRow","_$window","$","window","_prevCommentHeight","_prevWindowWidth","_resizeRegistered","renderContent","$el","html","defaults","model","attributes","anchorName","buildAnchorName","bindProperty","elementToModel","remove","Backbone","View","prototype","call","off","cid","setRows","defer","bind","_updateSize","show","on","positionCommentDlg","commentDlg","css","left","document","scrollLeft","width","top","offset","height","positionNotifyBubble","$bubble","get","windowWidth","commentHeight","outerHeight","getExtents"],"sources":["../../../../../static/rb/js/views/textBasedCommentBlockView.es6.js"],"sourcesContent":["/**\n * Provides a visual comment indicator to display comments for text-based file\n * attachments.\n *\n * This will show a comment indicator flag (a \"ghost comment flag\") beside the\n * content indicating there are comments there. It will also show the\n * number of comments, along with a tooltip showing comment summaries.\n *\n * This is meant to be used with a TextCommentBlock model.\n */\nRB.TextBasedCommentBlockView = RB.AbstractCommentBlockView.extend({\n    tagName: 'span',\n    className: 'commentflag',\n\n    template: _.template(dedent`\n        <span class=\"commentflag-shadow\"></span>\n        <span class=\"commentflag-inner\">\n         <span class=\"commentflag-count\"></span>\n        </span>\n        <a name=\"<%= anchorName %>\" class=\"commentflag-anchor\"></a>\n    `),\n\n    /**\n     * Initialize the view.\n     */\n    initialize() {\n        this.$beginRow = null;\n        this.$endRow = null;\n        this._$window = $(window);\n\n        this._prevCommentHeight = null;\n        this._prevWindowWidth = null;\n        this._resizeRegistered = false;\n    },\n\n    /**\n     * Render the contents of the comment flag.\n     *\n     * This will display the comment flag and then start listening for\n     * events for updating the comment count or repositioning the comment\n     * (for zoom level changes and wrapping changes).\n     *\n     * Returns:\n     *     RB.TextBasedCommentBlockView:\n     *     This object, for chaining.\n     */\n    renderContent() {\n        this.$el.html(this.template(_.defaults(this.model.attributes, {\n            anchorName: this.buildAnchorName(),\n        })));\n\n        this.$('.commentflag-count')\n            .bindProperty('text', this.model, 'count', {\n                elementToModel: false,\n            });\n    },\n\n    /**\n     * Remove the comment from the page.\n     */\n    remove() {\n        /*\n         * This can't use _.super() because AbstractCommentBlockView doesn't\n         * define a 'remove'.\n         */\n        Backbone.View.prototype.remove.call(this);\n\n        if (this._resizeRegistered) {\n            this._$window.off('resize.' + this.cid);\n        }\n    },\n\n    /**\n     * Set the row span for the comment flag.\n     *\n     * The comment will update to match the row of lines.\n     *\n     * Args:\n     *     $beginRow (jQuery):\n     *         The first row of the comment.\n     *\n     *     $endRow (jQuery):\n     *         The last row of the comment. This may be the same as\n     *         ``$beginRow``.\n     */\n    setRows($beginRow, $endRow) {\n        this.$beginRow = $beginRow;\n        this.$endRow = $endRow;\n\n        /*\n         * We need to set the sizes and show the element after other layout\n         * operations and the DOM have settled.\n         */\n        _.defer(_.bind(function() {\n            this._updateSize();\n            this.$el.show();\n        }, this));\n\n        if ($beginRow && $endRow) {\n            if (!this._resizeRegistered) {\n                this._$window.on('resize.' + this.cid,\n                                 _.bind(this._updateSize, this));\n            }\n        } else {\n            if (this._resizeRegistered) {\n                this._$window.off('resize.' + this.cid);\n            }\n        }\n    },\n\n    /**\n     * Position the comment dialog relative to the comment flag position.\n     *\n     * The dialog will be positioned in the center of the page (horizontally),\n     * just to the bottom of the flag.\n     *\n     * Args:\n     *     commntDlg (RB.CommentDialogView):\n     *          The view for the comment dialog.\n     */\n    positionCommentDlg(commentDlg) {\n        commentDlg.$el.css({\n            left: $(document).scrollLeft() +\n                  (this._$window.width() - commentDlg.$el.width()) / 2,\n            top: this.$endRow.offset().top + this.$endRow.height(),\n        });\n    },\n\n    /**\n     * Position the comment update notifications bubble.\n     *\n     * The bubble will be positioned just to the top-right of the flag.\n     *\n     * Args:\n     *     $bubble (jQuery):\n     *         The selector for the notification bubble.\n     */\n    positionNotifyBubble($bubble) {\n        $bubble.css({\n            left: this.$el.width(),\n            top: 0,\n        });\n    },\n\n    /**\n     * Return the name for the comment flag anchor.\n     *\n     * Returns:\n     *     string:\n     *     The name to use for the anchor element.\n     */\n    buildAnchorName() {\n        return `line${this.model.get('beginLineNum')}`;\n    },\n\n    /**\n     * Update the size of the comment flag.\n     */\n    _updateSize() {\n        const windowWidth = this._$window.width();\n\n        if (this._prevWindowWidth === windowWidth) {\n            return;\n        }\n\n        this._prevWindowWidth = windowWidth;\n\n        /*\n         * On IE and Safari, the marginTop in getExtents may be wrong.\n         * We force a value that ends up working for us.\n         */\n        const commentHeight = this.$endRow.offset().top +\n                              this.$endRow.outerHeight() -\n                              this.$beginRow.offset().top -\n                              (this.$el.getExtents('m', 't') || -4);\n\n        if (commentHeight !== this._prevCommentHeight) {\n            this.$el.height(commentHeight);\n            this._prevCommentHeight = commentHeight;\n        }\n    },\n});\n"],"mappings":"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"}