{"version":3,"file":"abstractCommentBlockView.js","names":["RB","AbstractCommentBlockView","Backbone","View","extend","events","tooltipSides","dispose","trigger","remove","_$tooltip","render","$","tooltip","$el","side","addClass","renderContent","model","on","_onDraftCommentChanged","_updateTooltip","hideTooltip","hide","positionCommentDlg","commentDlg","positionBeside","fitOnScreen","positionNotifyBubble","$bubble","move","Math","round","width","height","notify","text","cb","context","css","appendTo","animate","top","opacity","delay","_","isFunction","call","$list","draftComment","get","tooltipTemplate","template","user","UserSession","instance","html","forEach","comment","name","empty","append","removeClass","isEmpty","fadeOut","options","boundsUpdated","EnabledFeatures","unifiedBanner","DraftReviewBannerView","show","_onClicked"],"sources":["../../../../../static/rb/js/views/abstractCommentBlockView.es6.js"],"sourcesContent":["RB.AbstractCommentBlockView = Backbone.View.extend({\n    events: {\n        'click': '_onClicked'\n    },\n\n    tooltipSides: 'lrbt',\n\n    /**\n     * Dispose the comment block.\n     *\n     * This will remove the view and the tooltip.\n     */\n    dispose() {\n        this.trigger('removing');\n        this.remove();\n        this._$tooltip.remove();\n    },\n\n    /**\n     * Render the comment block.\n     *\n     * Along with the block, a floating tooltip will be created that\n     * displays summaries of the comments.\n     *\n     * Returns:\n     *     RB.AbstractCommentBlockView:\n     *     This object, for chaining.\n     */\n    render() {\n        this._$tooltip = $.tooltip(this.$el, { side: this.tooltipSides })\n            .addClass('comments');\n\n        this.renderContent();\n\n        this.model.on('change:draftComment', this._onDraftCommentChanged, this);\n        this._onDraftCommentChanged();\n\n        this._updateTooltip();\n\n        return this;\n    },\n\n    /**\n     * Hide the tooltip from the page.\n     *\n     * This will force the tooltip to hide, preventing it from interfering\n     * with operations such as moving a comment block.\n     *\n     * It will automatically show again the next time there is a mouse enter\n     * event.\n     */\n    hideTooltip() {\n        this._$tooltip.hide();\n    },\n\n    /**\n     * Position the comment dlg to the right side of comment block.\n     *\n     * This can be overridden to change where the comment dialog will\n     * be displayed.\n     *\n     * Args:\n     *     commntDlg (RB.CommentDialogView):\n     *          The view for the comment dialog.\n     */\n    positionCommentDlg(commentDlg) {\n        commentDlg.positionBeside(this.$el, {\n            side: 'r',\n            fitOnScreen: true\n        });\n    },\n\n    /**\n     * Position the notification bubble around the comment block.\n     *\n     * This can be overridden to change where the bubble will be displayed.\n     * By default, it is centered over the block.\n     *\n     * Args:\n     *     $bubble (jQuery):\n     *         The selector for the notification bubble.\n     */\n    positionNotifyBubble($bubble) {\n        $bubble.move(Math.round((this.$el.width()  - $bubble.width())  / 2),\n                     Math.round((this.$el.height() - $bubble.height()) / 2));\n    },\n\n    /**\n     * Notify the user of some update.\n     *\n     * This notification appears in the comment area.\n     *\n     * Args:\n     *     text (string):\n     *         The text to show in the notification.\n     *\n     *     cb (function, optional):\n     *         A callback function to call once the notification has been\n     *         removed.\n     *\n     *     context (object):\n     *         Context to bind when calling the ``cb`` callback function.\n     */\n    notify(text, cb, context) {\n        const $bubble = $('<div class=\"bubble\">')\n            .css('opacity', 0)\n            .appendTo(this.$el)\n            .text(text);\n\n        this.positionNotifyBubble($bubble);\n\n        $bubble\n            .animate({\n                top: '-=10px',\n                opacity: 0.8,\n            }, 350, 'swing')\n            .delay(1200)\n            .animate({\n                top: '+=10px',\n                opacity: 0,\n            }, 350, 'swing', () => {\n                $bubble.remove();\n\n                if (_.isFunction(cb)) {\n                    cb.call(context);\n                }\n            });\n    },\n\n    /**\n     * Update the tooltip contents.\n     *\n     * The contents will show the summary of each comment, including\n     * the draft comment, if any.\n     */\n    _updateTooltip() {\n        const $list = $('<ul>');\n        const draftComment = this.model.get('draftComment');\n        const tooltipTemplate = _.template(dedent`\n            <li>\n             <div class=\"reviewer\">\n              <%- user %>:\n             </div>\n             <pre class=\"rich-text\"><%= html %></pre>\n            </li>\n        `);\n\n        if (draftComment) {\n            $(tooltipTemplate({\n                user: RB.UserSession.instance.get('fullName'),\n                html: draftComment.get('html'),\n            }))\n            .addClass('draft')\n            .appendTo($list);\n        }\n\n        this.model.get('serializedComments').forEach(comment => {\n            $(tooltipTemplate({\n                user: comment.user.name,\n                html: comment.html,\n            }))\n            .appendTo($list);\n        });\n\n        this._$tooltip\n            .empty()\n            .append($list);\n    },\n\n    /**\n     * Handle changes to the model's draftComment property.\n     *\n     * If there's a new draft comment, we'll begin listening for updates\n     * on it in order to update the tooltip or display notification bubbles.\n     *\n     * The comment block's style will reflect whether or not we have a\n     * draft comment.\n     *\n     * If the draft comment is deleted, and there are no other comments,\n     * the view will be removed.\n     */\n    _onDraftCommentChanged() {\n        const comment = this.model.get('draftComment');\n\n        if (!comment) {\n            this.$el.removeClass('draft');\n            return;\n        }\n\n        comment.on('change:text', this._updateTooltip, this);\n\n        comment.on('destroy', () => {\n            this.notify(gettext('Comment Deleted'), () => {\n                // Discard the comment block if empty.\n                if (this.model.isEmpty()) {\n                    this.$el.fadeOut(350, () => this.dispose());\n                } else {\n                    this.$el.removeClass('draft');\n                    this._updateTooltip();\n                }\n            });\n        });\n\n        comment.on('saved', options => {\n            this._updateTooltip();\n\n            if (!options.boundsUpdated) {\n                this.notify(gettext('Comment Saved'));\n            }\n\n            if (!RB.EnabledFeatures.unifiedBanner) {\n                RB.DraftReviewBannerView.instance.show();\n            }\n        });\n\n        this.$el.addClass('draft');\n    },\n\n    /**\n     * Handle the comment block being clicked.\n     *\n     * Emits the 'clicked' signal so that parent views can process it.\n     */\n    _onClicked() {\n        this.trigger('clicked');\n    },\n});\n"],"mappings":"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"}