{"version":3,"file":"dndUploaderView.js","names":["DnDDropTarget","Backbone","Model","extend","defaults","$target","$","window","callback","dropText","gettext","DnDDropOverlayView","View","className","events","render","$el","text","model","get","show","addClass","_","defer","offset","width","outerWidth","height","outerHeight","css","left","top","hide","removeClass","close","fadeOut","trigger","remove","_onDrop","e","stopPropagation","preventDefault","dt","originalEvent","dataTransfer","files","file","Array","from","_onDragEnter","dropEffect","_onDragOver","_onDragLeave","RB","DnDUploader","initialize","_dropTargets","Collection","_dropOverlays","_hideOverlayTimeout","_overlaysVisible","_overlaysHiding","bindAll","on","_showOverlays","_hideOverlays","registerDropTarget","findWhere","undefined","target","add","overlay","appendTo","document","body","listenTo","push","console","error","unregisterDropTarget","overlayIx","findIndex","splice","types","includes","forEach","clearTimeout","setTimeout","instance","create","assert"],"sources":["dndUploaderView.es6.js"],"sourcesContent":["(function() {\n\n\n/**\n * A model for creating drag and drop targets.\n *\n * Registering a RB.DnDDropTarget with the RB.DnDUploader will create an\n * overlay on top of the target when files are dragged over the page. This\n * overlay will accept dropped files and run the dropAction for each file\n * dropped on it.\n *\n * Model Attributes:\n *     $target (jQuery):\n *         The target element to allow file drops on.\n *\n *     callback (function):\n *         The function to call when a file is dropped.\n *\n *     dropText (string):\n *         The string to show in the overlay.\n */\nconst DnDDropTarget = Backbone.Model.extend({\n    defaults() {\n        return {\n            $target: $(window),\n            callback: function() {},\n            dropText: gettext('Drop to upload')\n        };\n    }\n});\n\n\n/**\n * Displays an overlay over an element that accepts file drops.\n *\n * The overlay appears as semi-transparent black with the dropText message in\n * the center.\n *\n * If the user cancels the drop or moves the mouse out of the page, the\n * overlay will fade away.\n */\nconst DnDDropOverlayView = Backbone.View.extend({\n    className: 'dnd-overlay',\n\n    events: {\n        'dragenter': '_onDragEnter',\n        'dragover': '_onDragOver',\n        'dragleave': '_onDragLeave',\n        'drop': '_onDrop'\n    },\n\n    /**\n     * Render the view.\n     *\n     * Returns:\n     *     DnDDropOverlayView:\n     *     This object, for chaining.\n     */\n    render() {\n        this.$el.text(this.model.get('dropText'));\n\n        return this;\n    },\n\n    /**\n     * Show the overlay.\n     */\n    show() {\n        const $target = this.model.get('$target');\n        $target.addClass('dnd-overlay-visible');\n\n        /*\n         * Adding the class to the target may change its visibility or size.\n         * Let that clear before trying to position/size the overlay.\n         */\n        _.defer(() => {\n            const offset = $target.offset();\n            const width = $target.outerWidth() + 'px';\n            const height = $target.outerHeight() + 'px';\n\n            this.$el\n                .css({\n                    width: width,\n                    height: height,\n                    'line-height': height,\n                    left: offset.left + 'px',\n                    top: offset.top + 'px'\n                })\n                .show();\n        });\n    },\n\n    /**\n     * Hide the overlay.\n     */\n    hide() {\n        this.model.get('$target').removeClass('dnd-overlay-visible');\n        this.$el.hide();\n    },\n\n    /**\n     * Close the overlay.\n     *\n     * The overlay will fade out, and once it's gone, it will emit the \"closed\"\n     * event and remove itself from the page.\n     */\n    close() {\n        this.$el.fadeOut(() => {\n            this.trigger('closed');\n            this.remove();\n        });\n    },\n\n    /**\n     * Handle drop events on the overlay.\n     *\n     * This will call the appropriate callback for all dropped files.\n     *\n     * Args:\n     *     e (DragEvent):\n     *         The event that triggered the callback.\n     */\n    _onDrop(e) {\n        e.stopPropagation();\n        e.preventDefault();\n\n        const dt = e.originalEvent.dataTransfer;\n        const files = dt && dt.files;\n\n        if (files) {\n            const callback = this.model.get('callback');\n\n            for (let file of Array.from(files)) {\n                callback(file);\n            }\n        }\n\n        this.trigger('closing');\n    },\n\n    /**\n     * Handle dragenter events on the overlay.\n     *\n     * If there's files being dragged, the drop effect (usually represented\n     * by a mouse cursor) will be set to indicate a copy of the files.\n     *\n     * Args:\n     *     e (DragEvent):\n     *         The event that triggered the callback.\n     */\n    _onDragEnter(e) {\n        e.preventDefault();\n\n        const dt = e.originalEvent.dataTransfer;\n\n        if (dt) {\n            dt.dropEffect = 'copy';\n            this.$el.addClass('dnd-overlay-highlight');\n        }\n    },\n\n    /**\n     * Handle dragover events on the overlay.\n     *\n     * This merely prevents the default action, which indicates to the\n     * underlying API that this element can be dropped on.\n     *\n     * Args:\n     *     e (DragEvent):\n     *         The event which triggered the callback.\n     */\n    _onDragOver(e) {\n        e.preventDefault();\n    },\n\n    /**\n     * Handle dragleave events on the overlay.\n     *\n     * If there were files previously being dragged over the overlay,\n     * the drop effect will be reset.\n     *\n     * The overlay is always closed on a dragleave.\n     *\n     * Args:\n     *     e (DragEvent):\n     *         The event that triggered the callback.\n     */\n    _onDragLeave(e) {\n        e.preventDefault();\n\n        const dt = e.originalEvent.dataTransfer;\n\n        if (dt) {\n            dt.dropEffect = 'none';\n            this.$el.removeClass('dnd-overlay-highlight');\n        }\n    }\n});\n\n\n/*\n * Handles drag-and-drop file uploads for a review request.\n *\n * This makes it possible to drag files from a file manager and drop them\n * into Review Board. This requires browser support for HTML 5 file\n * drag-and-drop, which is available in most modern browsers.\n *\n * The moment the DnDUploader is created, it will begin listening for\n * DnD-related events on the window.\n */\nRB.DnDUploader = Backbone.View.extend({\n    /**\n     * Initialize the view.\n     */\n    initialize() {\n        this._dropTargets = new Backbone.Collection({\n            model: DnDDropTarget\n        });\n        this._dropOverlays = [];\n        this._hideOverlayTimeout = null;\n        this._overlaysVisible = false;\n        this._overlaysHiding = false;\n\n        _.bindAll(this, '_showOverlays', '_hideOverlays');\n\n        $(window)\n            .on('dragstart dragenter dragover', this._showOverlays)\n            .on('dragend dragleave', this._hideOverlays);\n    },\n\n    /**\n     * Register a new drop target.\n     *\n     * Args:\n     *     $target (jQuery):\n     *         The target element for drops.\n     *\n     *     dropText (string):\n     *         The text to show on the overlay.\n     *\n     *     callback (function):\n     *         The function to call when a file is dropped. This takes a single\n     *         file argument, and will be called for each file that is dropped\n     *         on the target.\n     */\n    registerDropTarget($target, dropText, callback) {\n        if (this._dropTargets.findWhere({ $target }) === undefined) {\n            const target = new DnDDropTarget({\n                $target,\n                dropText,\n                callback\n            });\n            this._dropTargets.add(target);\n\n            const overlay = new DnDDropOverlayView({\n                model: target\n            });\n\n            overlay.render().$el\n                .hide()\n                .appendTo(document.body);\n            this.listenTo(overlay, 'closing', this._hideOverlays);\n\n            this._dropOverlays.push(overlay);\n        } else {\n            console.error('Drop target was already registered!', $target);\n        }\n    },\n\n    /**\n     * Unregister an existing drop target.\n     *\n     * Args:\n     *     $target (jQuery):\n     *         The target element for drops.\n     */\n    unregisterDropTarget($target) {\n        const target = this._dropTargets.findWhere({ $target: $target });\n        const overlayIx = this._dropOverlays.findIndex(\n            overlay => (overlay.model === target));\n\n        if (overlayIx !== -1) {\n            this._dropOverlays[overlayIx].remove();\n            this._dropOverlays.splice(overlayIx, 1);\n        }\n\n        if (target !== undefined) {\n            this._dropTargets.remove(target);\n        }\n    },\n\n    /**\n     * Show the drop overlays.\n     *\n     * An overlay will be displayed over all the registered drop targets to\n     * give the user a place to drop the files onto. The overlay will report\n     * any files dropped.\n     *\n     * Args:\n     *     e (DragEvent):\n     *         The event that triggered the callback.\n     */\n    _showOverlays(e) {\n        if (e.originalEvent.dataTransfer !== undefined &&\n            Array.from(e.originalEvent.dataTransfer.types).includes('Files')) {\n            this._overlaysHiding = false;\n\n            if (!this._overlaysVisible) {\n                this._overlaysVisible = true;\n                this._dropOverlays.forEach(overlay => overlay.show());\n            }\n        }\n    },\n\n    /**\n     * Hide the drop overlays.\n     */\n    _hideOverlays() {\n        /*\n         * This will get called many times because the event bubbles up from\n         * all the children of the document. We only want to hide the overlays\n         * when the drag exits the window.\n         *\n         * In order to make this work reliably, we only hide the overlays after\n         * a timeout (to make sure there's not a dragenter event coming\n         * immediately after this).\n         */\n        if (this._hideOverlayTimeout) {\n            clearTimeout(this._hideOverlayTimeout);\n        }\n\n        this._overlaysHiding = true;\n        this._hideOverlayTimeout = setTimeout(() => {\n            if (this._overlaysHiding) {\n                this._overlaysVisible = false;\n                this._dropOverlays.forEach(overlay => overlay.hide());\n            }\n        }, 200);\n    }\n}, {\n    instance: null,\n\n    /**\n     * Create the DnDUploader instance.\n     *\n     * Returns:\n     *     RB.DnDUploader:\n     *     The new instance.\n     */\n    create() {\n        console.assert(RB.DnDUploader.instance === null,\n                       'DnDUploader.create may only be called once');\n\n        RB.DnDUploader.instance = new RB.DnDUploader();\n        return RB.DnDUploader.instance;\n    }\n});\n\n\n})();\n"],"mappings":"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"}