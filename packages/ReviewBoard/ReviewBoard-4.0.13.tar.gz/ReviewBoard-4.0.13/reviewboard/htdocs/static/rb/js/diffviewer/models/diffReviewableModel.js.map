{"version":3,"file":"diffReviewableModel.js","names":["RB","DiffReviewable","AbstractReviewable","extend","defaults","_","baseFileDiffID","file","fileDiffID","interdiffRevision","interFileDiffID","revision","prototype","commentBlockModel","DiffCommentBlock","defaultCommentBlockFields","loadSerializedCommentBlock","serializedCommentBlock","createCommentBlock","reviewRequest","get","review","beginLineNum","linenum","endLineNum","num_lines","serializedComments","comments","getRenderedDiff","callbacks","context","options","arguments","length","undefined","_fetchFragment","url","_buildRenderedDiffURL","index","showDeleted","noActivityIndicator","getRenderedDiffFragment","console","assert","chunkIndex","linesOfContext","apiCall","type","dataType","bindCallbacks","reviewURL","revisionPart","fileDiffPart","queryParts","push","TEMPLATE_SERIAL","queryStr","join"],"sources":["diffReviewableModel.es6.js"],"sourcesContent":["/**\n * Provides state and utility functions for loading and reviewing diffs.\n *\n * Model Attributes:\n *     baseFileDiffID (number):\n *         The ID of the base FileDiff.\n *\n *     fileDiffID (number):\n *         The ID of the FileDiff.\n *\n *     file (RB.DiffFile):\n *         Information on the file associated with this diff.\n *\n *     interdiffRevision (number):\n *         The revision on the end of an interdiff range.\n *\n *     interFileDiffID (number):\n *         The ID of the FileDiff on the end of an interdiff range.\n *\n *     revision (number):\n *         The revision of the FileDiff.\n *\n * See Also:\n *     :js:class:`RB.AbstractReviewable`:\n *         For the attributes defined by the base model.\n */\nRB.DiffReviewable = RB.AbstractReviewable.extend({\n    defaults: _.defaults({\n        baseFileDiffID: null,\n        file: null,\n        fileDiffID: null,\n        interdiffRevision: null,\n        interFileDiffID: null,\n        revision: null,\n    }, RB.AbstractReviewable.prototype.defaults),\n\n    commentBlockModel: RB.DiffCommentBlock,\n\n    defaultCommentBlockFields: [\n        'baseFileDiffID',\n        'fileDiffID',\n        'interFileDiffID',\n    ],\n\n    /**\n     * Load a serialized comment and add comment blocks for it.\n     *\n     * Args:\n     *     serializedCommentBlock (object):\n     *         The serialized data for the new comment block(s).\n     */\n    loadSerializedCommentBlock(serializedCommentBlock) {\n        this.createCommentBlock({\n            reviewRequest: this.get('reviewRequest'),\n            review: this.get('review'),\n            fileDiffID: this.get('fileDiffID'),\n            interFileDiffID: this.get('interFileDiffID'),\n            beginLineNum: serializedCommentBlock.linenum,\n            endLineNum: serializedCommentBlock.linenum +\n                        serializedCommentBlock.num_lines - 1,\n            serializedComments: serializedCommentBlock.comments || [],\n        });\n    },\n\n    /**\n     * Return the rendered diff for a file.\n     *\n     * The rendered file will be fetched from the server and eventually\n     * returned as the argument to the success callback.\n     *\n     * Args:\n     *     callbacks (object):\n     *         The functions used to fetch the corresponding diff fragments.\n     *\n     *     context (object):\n     *         The context passed to each callback function.\n     *\n     *     options (object, optional):\n     *         The option arguments that control the behavior of this function.\n     *\n     * Option Args:\n     *     showDeleted (boolean):\n     *         Determines whether or not we want to requeue the corresponding\n     *         diff in order to show its deleted content.\n     */\n    getRenderedDiff(callbacks, context, options={}) {\n        this._fetchFragment({\n            url: this._buildRenderedDiffURL({\n                index: this.get('file').get('index'),\n                showDeleted: options.showDeleted,\n            }),\n            noActivityIndicator: true,\n        }, callbacks, context);\n    },\n\n    /**\n     * Return a rendered fragment of a diff.\n     *\n     * The fragment will be fetched from the server and eventually returned\n     * as the argument to the success callback.\n     *\n     * Args:\n     *     options (object):\n     *         The option arguments that control the behavior of this function.\n     *\n     *     callbacks (object):\n     *         The functions used to fetch the corresponding diff fragments.\n     *\n     *     context (object):\n     *         The context passed to each callback function.\n     *\n     * Option Args:\n     *     chunkIndex (string):\n     *         The chunk index to load.\n     */\n    getRenderedDiffFragment(options, callbacks, context) {\n        console.assert(options.chunkIndex !== undefined,\n                       'chunkIndex must be provided');\n\n        this._fetchFragment({\n            url: this._buildRenderedDiffURL({\n                chunkIndex: options.chunkIndex,\n                index: this.get('file').get('index'),\n                linesOfContext: options.linesOfContext,\n            }),\n        }, callbacks, context);\n    },\n\n    /**\n     * Fetch the diff fragment from the server.\n     *\n     * This is used internally by getRenderedDiff and getRenderedDiffFragment\n     * to do all the actual fetching and calling of callbacks.\n     *\n     * Args:\n     *     options (object):\n     *         The option arguments that control the behavior of this function.\n     *\n     *     callbacks (object):\n     *         The functions used to fetch the corresponding diff fragments.\n     *\n     *     context (object):\n     *         The context passed to each callback function.\n     */\n    _fetchFragment(options, callbacks, context) {\n        RB.apiCall(_.defaults(\n            {\n                type: 'GET',\n                dataType: 'html'\n            },\n            options,\n            _.bindCallbacks(callbacks, context)\n        ));\n    },\n\n    /**\n     * Return a URL that forms the base of a diff fragment fetch.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the URL.\n     *\n     * Option Args:\n     *     chunkIndex (number, optional):\n     *         The chunk index to load.\n     *\n     *     index (number, optional):\n     *         The file index to load.\n     *\n     *     linesOfContext (number, optional):\n     *         The number of lines of context to load.\n     *\n     *     showDeleted (boolean, optional):\n     *         Whether to show deleted content.\n     *\n     * Returns:\n     *     string:\n     *     The URL for fetching diff fragments.\n     */\n    _buildRenderedDiffURL(options={}) {\n        const reviewURL = this.get('reviewRequest').get('reviewURL');\n        const interdiffRevision = this.get('interdiffRevision');\n        const fileDiffID = this.get('fileDiffID');\n        const interFileDiffID = this.get('interFileDiffID');\n        const baseFileDiffID = this.get('baseFileDiffID');\n        const revision = this.get('revision');\n\n        const revisionPart = (interdiffRevision\n                              ? `${revision}-${interdiffRevision}`\n                              : revision);\n\n        const fileDiffPart = (interFileDiffID\n                              ? `${fileDiffID}-${interFileDiffID}`\n                              : fileDiffID);\n\n        let url = `${reviewURL}diff/${revisionPart}/fragment/${fileDiffPart}/`;\n\n        if (options.chunkIndex !== undefined) {\n            url += `chunk/${options.chunkIndex}/`;\n        }\n\n        /* Build the query string. */\n        const queryParts = [];\n\n        if (baseFileDiffID) {\n            queryParts.push(`base-filediff-id=${baseFileDiffID}`);\n        }\n\n        if (options.index !== undefined) {\n            queryParts.push(`index=${options.index}`);\n        }\n\n        if (options.linesOfContext !== undefined) {\n            queryParts.push(`lines-of-context=${options.linesOfContext}`);\n        }\n\n        if (options.showDeleted) {\n            queryParts.push(`show-deleted=1`);\n        }\n\n        queryParts.push(`_=${TEMPLATE_SERIAL}`);\n\n        const queryStr = queryParts.join('&');\n\n        return `${url}?${queryStr}`;\n    },\n});\n"],"mappings":"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"}