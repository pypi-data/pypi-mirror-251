{"version":3,"file":"draftResourceModelMixin.js","names":["RB","DraftResourceModelMixin","ready","options","context","get","isNew","_needDraft","undefined","_super","call","_","defaults","_retrieveDraft","destroy","_this","bindCallbacks","success","isFunction","_len","arguments","length","args","Array","_key","apply","url","parentObject","linkName","result","links","href","$","now","UserSession","instance","error","errorText","gettext","data","extraQueryArgs","isEmpty","extend","Backbone","Model","prototype","fetch","processData","model","xhr","status"],"sources":["draftResourceModelMixin.es6.js"],"sourcesContent":["/**\n * Mixin for resources that have special \"draft\" URLs.\n *\n * Some resources contain a \"draft/\" singleton URL that will either redirect to\n * the URL for an existing draft, or indicate there's no draft (and requiring\n * that one be created).\n *\n * These resources need a little more logic to look up the draft state and\n * craft the proper URL. They can use this mixin to do that work for them.\n */\nRB.DraftResourceModelMixin = {\n    /**\n     * Call a function when the object is ready to use.\n     *\n     * If the object is unloaded, we'll likely need to grab the draft\n     * resource, particularly if we haven't already retrieved a draft.\n     *\n     * Otherwise, we delegate to the parent's ready().\n     *\n     * Args:\n     *     options (object):\n     *         Options for the operation, including callbacks.\n     *\n     *     context (object):\n     *         Context to bind when calling callbacks.\n     */\n    ready(options, context) {\n        if (!this.get('loaded') && this.isNew() &&\n            this._needDraft === undefined) {\n            this._needDraft = true;\n        }\n\n        if (this._needDraft) {\n            /*\n             * Start by delegating to the parent ready() function. Because the\n             * object is \"new\", this will make sure that the parentObject is\n             * ready.\n             */\n            _super(this).ready.call(\n                this,\n                _.defaults({\n                    ready: () => this._retrieveDraft(options, context),\n                }, options),\n                context);\n        } else {\n            _super(this).ready.call(this, options, context);\n        }\n    },\n\n    /**\n     * Destroy the object.\n     *\n     * If destruction is successful, we'll reset the needDraft state so we'll\n     * look up the draft the next time an operation is performed.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the operation, including callbacks.\n     *\n     *     context (object):\n     *         Context to bind when calling callbacks.\n     */\n    destroy(options, context) {\n        options = _.bindCallbacks(options || {});\n\n        this.ready(\n            _.defaults({\n                ready: () => {\n                    _super(this).destroy.call(\n                        this,\n                        _.defaults({\n                            success: (...args) => {\n                                /* We need to fetch the draft resource again. */\n                                this._needDraft = true;\n\n                                if (_.isFunction(options.success)) {\n                                    options.success.apply(context, args);\n                                }\n                            }\n                        }, options),\n                        this);\n                }\n            }, options),\n            this);\n    },\n\n    /**\n     * Return the URL to use when syncing the model.\n     *\n     * Custom URL implementation which will return the special draft resource\n     * if we have yet to redirect and otherwise delegate to the prototype\n     * implementation.\n     *\n     * Returns:\n     *     string:\n     *     The URL to use for the resource.\n     */\n    url() {\n        if (this._needDraft) {\n            const parentObject = this.get('parentObject');\n            const linkName = _.result(this, 'listKey');\n            const links = parentObject.get('links');\n\n            /*\n             * Chrome hyper-aggressively caches things it shouldn't, and\n             * appears to do so in a subtly broken way.\n             *\n             * If we do a DELETE on a reply's URL, then later a GET (resulting\n             * from a redirect from a GET to draft/), Chrome will somehow get\n             * confused and associate the GET's caching information with a 404.\n             *\n             * In order to prevent this, we need to make requests to draft/\n             * appear unique. We can do this by appending the timestamp here.\n             * Chrome will no longer end up with broken state for our later\n             * GETs.\n             *\n             * Much of this is only required in the case of sqlite, which,\n             * with Django, may reuse row IDs, causing problems when making\n             * a reply, deleting, and making a new one. In production, this\n             * shouldn't be a problem, but it's very confusing during\n             * development.\n             */\n            return links[linkName].href + 'draft/?' + $.now();\n        } else {\n            return _super(this).url.call(this);\n        }\n    },\n\n    /**\n     * Try to retrieve an existing draft from the server.\n     *\n     * This uses the special draft/ resource within the resource list, which\n     * will redirect to an existing draft if one exists.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the operation, including callbacks.\n     *\n     *     context (object):\n     *         Context to bind when calling callbacks.\n     */\n    _retrieveDraft(options={}, context=undefined) {\n        if (!RB.UserSession.instance.get('authenticated')) {\n            if (options.error) {\n                options.error.call(context, {\n                    errorText: gettext('You must be logged in to retrieve the draft.')\n                });\n            }\n\n            return;\n        }\n\n        let data = options.data || {};\n        const extraQueryArgs = _.result(this, 'extraQueryArgs', {});\n\n        if (!_.isEmpty(extraQueryArgs)) {\n            data = _.extend({}, extraQueryArgs, data);\n        }\n\n        Backbone.Model.prototype.fetch.call(this, {\n            data: data,\n            processData: true,\n            success: () => {\n                /*\n                 * There was an existing draft, and we were redirected to it\n                 * and pulled data from it. We're done.\n                 */\n                this._needDraft = false;\n\n                if (options && _.isFunction(options.ready)) {\n                    options.ready.call(context);\n                }\n            },\n            error: (model, xhr) => {\n                if (xhr.status === 404) {\n                    /*\n                     * We now know we don't have an existing draft to work with,\n                     * and will eventually need to POST to create a new one.\n                     */\n                    this._needDraft = false;\n                    options.ready.call(context);\n                } else if (options && _.isFunction(options.error)) {\n                    options.error.call(context, xhr, xhr.status);\n                }\n            }\n        });\n    }\n};\n"],"mappings":"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"}