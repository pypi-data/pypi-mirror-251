{"version":3,"file":"abstractReviewableView.js","names":["RB","AbstractReviewableView","Backbone","View","extend","commentBlockView","commentsListName","initialize","options","console","assert","commentDlg","_activeCommentBlock","renderedInline","render","renderContent","model","commentBlocks","each","_addCommentBlockView","on","createAndEditCommentBlock","get","confirm","gettext","defaultCommentBlockFields","_","result","length","reviewableIDField","log","once","showCommentDlg","pick","attributes","createCommentBlock","commentBlock","ensureDraftComment","stopListening","CommentDialogView","create","comment","publishedComments","publishedCommentsType","position","dlg","positionCommentDlg","listenTo","trigger"],"sources":["../../../../../static/rb/js/views/abstractReviewableView.es6.js"],"sourcesContent":["/**\n * Abstract base for review UIs.\n *\n * This provides all the basics for creating a review UI. It does the\n * work of loading in comments, creating views, and displaying comment dialogs,\n */\nRB.AbstractReviewableView = Backbone.View.extend({\n    /**\n     * The AbstractCommentBlockView subclass.\n     *\n     * This is the type that will be instantiated for rendering comment blocks.\n     */\n    commentBlockView: null,\n\n    /**\n     * The list type (as a string) for passing to CommentDlg.\n     */\n    commentsListName: null,\n\n    /**\n     * Initialize AbstractReviewableView.\n     *\n     * Args:\n     *     options (object, optional):\n     *         Options for the view.\n     */\n    initialize(options={}) {\n        console.assert(this.commentBlockView,\n                       'commentBlockView must be defined by the subclass');\n        console.assert(this.commentsListName,\n                       'commentsListName must be defined by the subclass');\n\n        this.commentDlg = null;\n        this._activeCommentBlock = null;\n        this.renderedInline = options.renderedInline || false;\n    },\n\n    /**\n     * Render the reviewable to the page.\n     *\n     * This will call the subclass's renderContent(), and then handle\n     * rendering each comment block on the reviewable.\n     *\n     * Returns:\n     *     RB.AbstractReviewableView:\n     *     This object, for chaining.\n     */\n    render() {\n        this.renderContent();\n\n        this.model.commentBlocks.each(this._addCommentBlockView, this);\n        this.model.commentBlocks.on('add', this._addCommentBlockView, this);\n\n        return this;\n    },\n\n    /**\n     * Render the content of the reviewable.\n     *\n     * This should be overridden by subclasses.\n     */\n    renderContent() {\n    },\n\n    /**\n     * Create a new comment in a comment block and opens it for editing.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the comment block creation.\n     */\n    createAndEditCommentBlock(options) {\n        if (this.commentDlg !== null &&\n            this.commentDlg.model.get('dirty') &&\n            !confirm(gettext('You are currently editing another comment. Would you like to discard it and create a new one?'))) {\n            return;\n        }\n\n        let defaultCommentBlockFields =\n            _.result(this.model, 'defaultCommentBlockFields');\n\n        if (defaultCommentBlockFields.length === 0 &&\n            this.model.reviewableIDField) {\n            console.log('Deprecation notice: Reviewable subclass is missing ' +\n                        'defaultCommentBlockFields. Rename reviewableIDField ' +\n                        'to defaultCommentBlockFields, and make it a list.');\n            defaultCommentBlockFields = [this.model.reviewableIDField];\n        }\n\n        /* As soon as we add the comment block, show the dialog. */\n        this.once('commentBlockViewAdded',\n                  commentBlockView => this.showCommentDlg(commentBlockView));\n\n        _.extend(options,\n                 _.pick(this.model.attributes, defaultCommentBlockFields));\n        this.model.createCommentBlock(options);\n    },\n\n    /**\n     * Show the comment details dialog for a comment block.\n     *\n     * Args:\n     *     commentBlockView (RB.AbstractCommentBlockView):\n     *         The comment block to show the dialog for.\n     */\n    showCommentDlg(commentBlockView) {\n        const commentBlock = commentBlockView.model;\n\n        commentBlock.ensureDraftComment();\n\n        if (this._activeCommentBlock === commentBlock) {\n            return;\n        }\n\n        this.stopListening(this.commentDlg, 'closed');\n        this.commentDlg = RB.CommentDialogView.create({\n            comment: commentBlock.get('draftComment'),\n            publishedComments: commentBlock.get('serializedComments'),\n            publishedCommentsType: this.commentsListName,\n            position: dlg => commentBlockView.positionCommentDlg(dlg),\n        });\n        this._activeCommentBlock = commentBlock;\n\n        this.listenTo(this.commentDlg, 'closed', () => {\n            this.commentDlg = null;\n            this._activeCommentBlock = null;\n        });\n    },\n\n    /**\n     * Add a CommentBlockView for the given CommentBlock.\n     *\n     * This will create a view for the block, render it, listen for clicks\n     * in order to show the comment dialog, and then emit\n     * 'commentBlockViewAdded'.\n     *\n     * Args:\n     *     commentBlock (RB.AbstractCommentBlock):\n     *         The comment block to add a view for.\n     */\n    _addCommentBlockView(commentBlock) {\n        const commentBlockView = new this.commentBlockView({\n            model: commentBlock\n        });\n\n        commentBlockView.on('clicked', () => this.showCommentDlg(commentBlockView));\n        commentBlockView.render();\n        this.trigger('commentBlockViewAdded', commentBlockView);\n    },\n});\n"],"mappings":"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"}