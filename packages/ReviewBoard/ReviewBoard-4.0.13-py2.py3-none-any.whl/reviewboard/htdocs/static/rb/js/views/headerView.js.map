{"version":3,"file":"headerView.js","names":["RB","HeaderView","Backbone","View","extend","SEARCH_SUMMARY_TRIM_LEN","DESKTOP_SEARCH_RESULTS_WIDTH","events","initialize","options","arguments","length","undefined","instance","console","warn","isRendered","_mobileMenuOpened","_$window","_$body","_$navToggle","_$mobileMenuMask","remove","off","prototype","call","render","$","window","body","document","on","_closeMobileMenu","bind","insertAfter","$pageSidebar","_","throttle","_recalcMobileMode","_setupSearch","_handleNavClick","e","stopPropagation","preventDefault","_setMobileMenuOpened","inMobileMode","is","trigger","_$search","rbautocomplete","formatItem","data","s","username","fullname","escape","name","displayName","display_name","summary","substring","id","matchCase","multiple","clickToURL","selectFirst","width","enterToURL","resultsParentEl","resultsClass","parse","objects","keys","parsed","j","object","items","search","i","value","key","push","result","public","url","SITE_ROOT","opened","show","defer","addClass","removeClass","delay","hide"],"sources":["headerView.es6.js"],"sourcesContent":["/**\n * Site Header\n */\nRB.HeaderView = Backbone.View.extend({\n    SEARCH_SUMMARY_TRIM_LEN: 28,\n    DESKTOP_SEARCH_RESULTS_WIDTH: 350,\n\n    events: {\n        'click #nav_toggle': '_handleNavClick',\n        'touchstart #nav_toggle': '_handleNavClick',\n        'focus #search_field': '_closeMobileMenu',\n    },\n\n    /**\n     * Initialize the header.\n     *\n     * Args:\n     *     options (object, optional):\n     *         Options for the view.\n     *\n     * Option Args:\n     *     $body (jQuery, optional):\n     *         The body element. This is useful for unit tests.\n     *\n     *     $pageSidebar (jQuery, optional):\n     *         The page sidebar element. This is useful for unit tests.\n     */\n    initialize(options={}) {\n        if (RB.HeaderView.instance !== null) {\n            console.warn('There are two instances of RB.HeaderView on the ' +\n                         'page. Make sure only one RB.PageView is ' +\n                         'instantiated and registered through ' +\n                         'RB.PageManager.setupPage().');\n        } else {\n            RB.HeaderView.instance = this;\n        }\n\n        this.options = options;\n\n        /*\n         * This is used by RB.PageManager to determine if a RB.PageView\n         * subclass has correctly rendered a HeaderView, or if PageManager\n         * needs to take care of it.\n         *\n         * This is deprecated and can be removed in Review Board 5.0.\n         */\n        this.isRendered = false;\n\n        this._mobileMenuOpened = false;\n\n        this._$window = null;\n        this._$body = null;\n        this._$navToggle = null;\n        this._$mobileMenuMask = null;\n    },\n\n    /**\n     * Remove the view from the DOM and disable event handling.\n     *\n     * This will also unset :js:attr:`RB.HeaderView.instance`, if currently\n     * set to this instance.\n     */\n    remove() {\n        if (RB.HeaderView.instance === this) {\n            RB.HeaderView.instance = null;\n        }\n\n        if (this._$window) {\n            this._$window.off('resize.rbHeaderView');\n        }\n\n        Backbone.View.prototype.remove.call(this);\n    },\n\n    /**\n     * Render the header.\n     *\n     * Returns:\n     *     RB.HeaderView:\n     *     This view, for chaining.\n     */\n    render() {\n        const options = this.options;\n\n        this._$window = $(window);\n        this._$body = options.body || $(document.body);\n        this._$navToggle = $('#nav_toggle');\n        this._$mobileMenuMask = $('<div id=\"mobile_menu_mask\"/>')\n            .on('click touchstart', this._closeMobileMenu.bind(this))\n            .insertAfter(options.$pageSidebar || $('#page-sidebar'));\n\n        this._$window.on('resize.rbHeaderView', _.throttle(\n            this._recalcMobileMode.bind(this),\n            100));\n        this._recalcMobileMode();\n\n        this._setupSearch();\n\n        this.isRendered = true;\n\n        return this;\n    },\n\n    /**\n     * Handle a click on the mobile navigation menu.\n     *\n     * Args:\n     *     e (Event):\n     *         The click event.\n     */\n    _handleNavClick(e) {\n        e.stopPropagation();\n        e.preventDefault();\n\n        this._setMobileMenuOpened(!this._mobileMenuOpened);\n    },\n\n    /**\n     * Recalculate whether the header and nav menu is in mobile mode.\n     */\n    _recalcMobileMode() {\n        const inMobileMode = this._$navToggle.is(':visible');\n\n        if (inMobileMode === this.inMobileMode) {\n            return;\n        }\n\n        if (!inMobileMode) {\n            this._setMobileMenuOpened(false);\n        }\n\n        this.inMobileMode = inMobileMode;\n        this.trigger('mobileModeChanged', inMobileMode);\n    },\n\n    /**\n     * Close the mobile menu.\n     *\n     * This is used as an event handler, to make it easy to close the\n     * mobile menu and prevent any bubbling or default actions from the\n     * event.\n     */\n    _closeMobileMenu() {\n        this._setMobileMenuOpened(false);\n\n        return false;\n    },\n\n    /**\n     * Set up the search auto-complete field.\n     */\n    _setupSearch() {\n        this._$search = $('#search_field').rbautocomplete({\n            formatItem: data => {\n                let s;\n\n                if (data.username) {\n                    // For the format of users:\n                    s = data.username;\n\n                    if (data.fullname) {\n                        s += ` <span>(${_.escape(data.fullname)})</span>`;\n                    }\n\n                } else if (data.name) {\n                    // For the format of groups:\n                    const displayName = _.escape(data.display_name);\n                    s = `${data.name} <span>(${displayName})</span>`;\n                } else if (data.summary) {\n                    // For the format of review requests:\n                    if (data.summary.length < this.SEARCH_SUMMARY_TRIM_LEN) {\n                        s = data.summary;\n                    } else {\n                        s = data.summary.substring(\n                            0, this.SEARCH_SUMMARY_TRIM_LEN);\n                    }\n\n                    s += ` <span>(${_.escape(data.id)})</span>`;\n                }\n\n                return s;\n            },\n            matchCase: false,\n            multiple: false,\n            clickToURL: true,\n            selectFirst: false,\n            width: this.DESKTOP_SEARCH_RESULTS_WIDTH,\n            enterToURL: true,\n            resultsParentEl: $('#page-container'),\n            resultsClass: 'ui-autocomplete-results search-results',\n            parse: data => {\n                const objects = ['users', 'groups', 'review_requests'];\n                const keys = ['username', 'name', 'summary'];\n\n                const parsed = [];\n\n                for (let j = 0; j < objects.length; j++) {\n                    const object = objects[j];\n                    const items = data.search[object];\n\n                    for (let i = 0; i < items.length; i++) {\n                        const value = items[i];\n                        const key = keys[j];\n\n\n                        if (j !== 2) {\n                            // For users and groups, always show.\n                            parsed.push({\n                                data: value,\n                                value: value[key],\n                                result: value[key],\n                            });\n                        } else if (value.public) {\n                            /*\n                             * For review requests, only show ones that are\n                             * public.\n                             */\n                            parsed.push({\n                                data: value,\n                                value: value[key],\n                                result: value[key],\n                            });\n                        }\n                    }\n                }\n\n                return parsed;\n            },\n            url: `${SITE_ROOT}api/search/`,\n        });\n    },\n\n    /**\n     * Set whether the mobile menu is opened.\n     *\n     * Args:\n     *     opened (boolean):\n     *         Whether the menu is open.\n     */\n    _setMobileMenuOpened(opened) {\n        if (opened === this._mobileMenuOpened) {\n            return;\n        }\n\n        if (opened) {\n            this._$mobileMenuMask.show();\n            _.defer(() => this._$body.addClass('js-mobile-menu-open'));\n        } else {\n            this._$body.removeClass('js-mobile-menu-open');\n            _.delay(() => this._$mobileMenuMask.hide(), 300);\n        }\n\n        this._mobileMenuOpened = opened;\n    },\n}, {\n    /** The instance of the HeaderView. */\n    instance: null,\n});\n"],"mappings":"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"}