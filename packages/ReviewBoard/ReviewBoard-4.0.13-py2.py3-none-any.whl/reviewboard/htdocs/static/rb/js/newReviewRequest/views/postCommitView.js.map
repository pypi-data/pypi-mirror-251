{"version":3,"file":"postCommitView.js","names":["RB","PostCommitView","Backbone","View","extend","className","loadErrorTemplate","_","template","events","initialize","options","model","repository","get","branches","_$scrollContainer","$scrollContainer","_$error","_branchesView","BranchesView","collection","on","branch","set","listenTo","_onBranchChanged","loaded","_loadBranches","render","_rendered","$","addClass","append","text","gettext","el","appendTo","$el","_commitsView","_clearLoadError","fetch","success","show","error","xhr","hide","_showLoadError","_loadCommits","_commitsCollection","checkFetchNext","remove","reloadID","errorLoadingText","temporaryFailureText","tryAgainText","errorLines","errorText","split","stopListening","getCommits","id","start","_onCreateReviewRequest","CommitsView","commit","_createPending","setPending","reviewRequest","ReviewRequest","localSitePrefix","createFromCommit","commitID","window","location","alert"],"sources":["postCommitView.es6.js"],"sourcesContent":["/**\n * A view orchestrating post-commit review request creation.\n *\n * This brings together the BranchesView and CommitsView to provide a UI for\n * letting people browse through the committed revisions in the repository. When\n * the user clicks on one of the commits, it will create a new review request\n * using that commit's ID.\n */\nRB.PostCommitView = Backbone.View.extend({\n    className: 'post-commit',\n\n    loadErrorTemplate: _.template(dedent`\n        <div class=\"error\">\n         <p><%- errorLoadingText %></p>\n         <p class=\"error-text\">\n          <% _.each(errorLines, function(line) { %><%- line %><br /><% }); %>\n         </p>\n         <p>\n          <%- temporaryFailureText %>\n          <a href=\"#\" id=\"reload_<%- reloadID %>\"><%- tryAgainText %></a>\n         </p>\n        </div>\n    `),\n\n    events: {\n        'click #reload_branches': '_loadBranches',\n        'click #reload_commits': '_loadCommits',\n    },\n\n    /**\n     * Initialize the view.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the view.\n     *\n     * Option Args:\n     *     $scrollContainer (jQuery):\n     *         The parent container handling all content scrolling.\n     */\n    initialize(options) {\n        const model = this.model;\n        const repository = model.get('repository');\n        const branches = repository.branches;\n\n        this._$scrollContainer = options.$scrollContainer;\n        this._$error = null;\n\n        // Set up the branch selector and bind it to the \"branch\" attribute\n        this._branchesView = new RB.BranchesView({\n            collection: branches,\n        });\n        this._branchesView.on('selected',\n                              branch => model.set('branch', branch));\n\n        this.listenTo(model, 'change:branch', this._onBranchChanged);\n\n        if (!branches.loaded) {\n            this._loadBranches();\n        }\n    },\n\n    /**\n     * Render the view.\n     *\n     * Returns:\n     *     RB.PostCommitView:\n     *     This object, for chaining.\n     */\n    render() {\n        this._rendered = true;\n\n        $('<div/>')\n            .addClass('branches section-header')\n            .append($('<span/>')\n                .text(gettext('Create from an existing commit on:')))\n            .append(this._branchesView.render().el)\n            .appendTo(this.$el);\n\n        if (this._commitsView) {\n            this.$el.append(this._commitsView.render().el);\n        }\n\n        return this;\n    },\n\n    /**\n     * Load the list of branches from the repository.\n     *\n     * If there's an error loading the branches, the branches selector and\n     * commits list will be hidden, and an error will be displayed along\n     * with the message from the server. The user will have the ability to\n     * try again.\n     */\n    _loadBranches() {\n        this._clearLoadError();\n\n        const branches = this.model.get('repository').branches;\n\n        branches.fetch({\n            success: () => {\n                branches.loaded = true;\n\n                this._branchesView.$el.show();\n\n                if (this._commitsView) {\n                    this._commitsView.$el.show();\n                }\n            },\n            error: (collection, xhr) => {\n                this._branchesView.$el.hide();\n\n                if (this._commitsView) {\n                    this._commitsView.$el.hide();\n                }\n\n                this._showLoadError('branches', xhr);\n            },\n        });\n    },\n\n    /**\n     * Load the list of commits from the repository.\n     *\n     * If there's an error loading the commits, the commits list will be\n     * hidden, and an error will be displayed along with the message from\n     * the server. The user will have the ability to try again.\n     */\n    _loadCommits() {\n        this._clearLoadError();\n\n        this._commitsCollection.fetch({\n            success: () => {\n                this._commitsView.$el.show();\n                this._commitsView.checkFetchNext();\n            },\n            error: (collection, xhr) => {\n                this._commitsView.$el.hide();\n                this._showLoadError('commits', xhr);\n            },\n        });\n    },\n\n    /**\n     * Clear any displayed error message.\n     */\n    _clearLoadError() {\n        if (this._$error) {\n            this._$error.remove();\n            this._$error = null;\n        }\n    },\n\n    /**\n     * Show an error message indicating a load failure.\n     *\n     * The message from the server will be displayed along with some\n     * helpful text and a link for trying the request again.\n     *\n     * Args:\n     *     reloadID (string):\n     *         An ID to use for the reload link element.\n     *\n     *     xhr (jqXHR):\n     *         The HTTP Request object.\n     */\n    _showLoadError(reloadID, xhr) {\n        this._clearLoadError();\n\n        this._$error = $(this.loadErrorTemplate({\n                errorLoadingText: gettext('There was an error loading information from this repository:'),\n                temporaryFailureText: gettext('This may be a temporary failure.'),\n                tryAgainText: gettext('Try again'),\n                errorLines: xhr.errorText.split('\\n'),\n                reloadID: reloadID,\n            }))\n            .appendTo(this.$el);\n    },\n\n    /**\n     * Callback for when the user chooses a different branch.\n     *\n     * Fetches a new list of commits starting from the tip of the selected\n     * branch.\n     *\n     * Args:\n     *     model (RB.PostCommitModel):\n     *         The data model.\n     *\n     *     branch (RB.RepositoryBranch):\n     *         The selected branch.\n     */\n    _onBranchChanged(model, branch) {\n        if (this._commitsView) {\n            this.stopListening(this._commitsCollection);\n            this._commitsView.remove();\n        }\n\n        this._commitsCollection =\n            this.model.get('repository').getCommits({\n                branch: branch.id,\n                start: branch.get('commit'),\n            });\n        this.listenTo(this._commitsCollection, 'create',\n                      this._onCreateReviewRequest);\n\n        this._commitsView = new RB.CommitsView({\n            collection: this._commitsCollection,\n            $scrollContainer: this._$scrollContainer,\n        });\n        this.listenTo(this._commitsView, 'loadError', xhr => {\n            this._showLoadError('commits', xhr);\n        });\n\n        if (this._rendered) {\n            this.$el.append(this._commitsView.render().el);\n        }\n\n        this._loadCommits();\n    },\n\n    /**\n     * Callback for when a commit is selected.\n     *\n     * Creates a new review request with the given commit ID and redirects the\n     * browser to it.\n     *\n     * Args:\n     *     commit (RB.RepositoryCommit):\n     *         The selected commit.\n     */\n    _onCreateReviewRequest(commit) {\n        if (this._createPending) {\n            // Do nothing\n            return;\n        }\n\n        this._createPending = true;\n        this._commitsView.setPending(commit);\n\n        const repository = this.model.get('repository');\n        const reviewRequest = new RB.ReviewRequest({\n            repository: repository.id,\n            localSitePrefix: repository.get('localSitePrefix')\n        });\n\n        reviewRequest.createFromCommit({\n            commitID: commit.id,\n            success: () => {\n                window.location = reviewRequest.get('reviewURL');\n            },\n            error: (model, xhr) => {\n                this._commitsView.setPending(null);\n                this._createPending = false;\n                alert(xhr.errorText);\n            },\n        });\n    },\n});\n"],"mappings":"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"}