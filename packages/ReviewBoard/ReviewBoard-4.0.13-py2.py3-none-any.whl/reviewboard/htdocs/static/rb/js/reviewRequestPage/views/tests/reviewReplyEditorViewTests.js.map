{"version":3,"file":"reviewReplyEditorViewTests.js","names":["suite","reviewReply","editor","view","beforeEach","$container","$","appendTo","$testsScratch","RB","ReviewReply","id","spyOn","and","callFake","options","context","success","call","ReviewRequestPage","ReviewReplyEditor","anchorPrefix","replyObject","review","Review","parentObject","ReviewRequest","contextType","contextID","ReviewReplyEditorView","model","el","_$commentsList","append","describe","it","commentText","now","moment","$el","_makeCommentElement","commentID","text","render","expect","get","toBe","valueOf","milliseconds","_$draftComment","_$addCommentLink","is","click","not","hasClass","length","trigger","$draftEl","fn","callThrough","set","data","user_infobox","toHaveBeenCalled","timesince","$anchor","children","attr","$floatingAnchor","find","openCommentEditor","testRendering","richText","expectedHTML","$comment","$reviewText","html"],"sources":["reviewReplyEditorViewTests.es6.js"],"sourcesContent":["suite('rb/reviewRequestPage/views/ReviewReplyEditorView', function() {\n    let reviewReply;\n    let editor;\n    let view;\n\n    beforeEach(function() {\n        const $container = $('<div/>').appendTo($testsScratch);\n\n        reviewReply = new RB.ReviewReply({\n            id: 121\n        });\n\n        /* Some tests will invoke this, so just pretend it works. */\n        spyOn(reviewReply, 'discardIfEmpty').and.callFake(\n            (options, context) => options.success.call(context));\n\n        editor = new RB.ReviewRequestPage.ReviewReplyEditor({\n            anchorPrefix: 'header-reply',\n            replyObject: reviewReply,\n            review: new RB.Review({\n                id: 42,\n                parentObject: new RB.ReviewRequest(),\n            }),\n            reviewReply: reviewReply,\n            contextType: 'rcbt',\n            contextID: '100',\n        });\n\n        view = new RB.ReviewRequestPage.ReviewReplyEditorView({\n            model: editor,\n            el: $testsScratch,\n        });\n\n        /* Necessary to do pre-render so we can use makeCommentElement. */\n        view._$commentsList = $('<ul class=\"reply-comments\"/>');\n\n        $container\n            .append(view._$commentsList)\n            .append($('<a href=\"#\" class=\"add_comment_link\">New Comment</a>'));\n    });\n\n    describe('Construction', function() {\n        it('Populate from draft comment', function() {\n            const commentText = 'Test comment';\n            const now = moment();\n            const $el = view._makeCommentElement({\n                commentID: 16,\n                now: now,\n                text: commentText,\n            });\n\n            view.render();\n\n            expect(editor.get('commentID')).toBe(16);\n            expect(editor.get('text')).toBe(commentText);\n            expect(editor.get('hasDraft')).toBe(true);\n            expect(editor.get('timestamp').valueOf())\n                .toBe(now.milliseconds(0).valueOf());\n            expect(view._$draftComment[0]).toBe($el[0]);\n            expect(view._$addCommentLink.is(':visible')).toBe(false);\n        });\n    });\n\n    describe('Actions', function() {\n        it('Add comment link', function() {\n            view.render();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(true);\n            view._$addCommentLink.click();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(false);\n            expect(view._$draftComment).not.toBe(null);\n            expect(view._$draftComment.hasClass('draft')).toBe(true);\n        });\n    });\n\n    describe('Event handling', function() {\n        it('Comment discarded', function() {\n            view._makeCommentElement({\n                text: 'Test comment',\n            });\n\n            view.render();\n\n            let $el = view.$('.reply-comments li');\n            expect($el.length).toBe(1);\n\n            reviewReply.trigger('destroyed');\n\n            $el = view.$('.reply-comments li');\n            expect($el.length).toBe(0);\n            expect(view._$draftComment).toBe(null);\n        });\n\n        it('Comment published', function() {\n            const $draftEl = view._makeCommentElement({\n                commentID: 16,\n            });\n\n            spyOn($.fn, 'user_infobox').and.callThrough();\n            spyOn($.fn, 'timesince').and.callThrough();\n\n            view.render();\n            editor.set('text', 'Test **comment**');\n            reviewReply.trigger('published');\n\n            const $el = view.$('.reply-comments li');\n\n            expect($el.length).toBe(1);\n            expect($draftEl).not.toBe($el);\n            expect($el.hasClass('draft')).toBe(false);\n            expect($el.data('comment-id')).toBe(16);\n            expect(view._$draftComment).toBe(null);\n            expect($.fn.user_infobox).toHaveBeenCalled();\n            expect($.fn.timesince).toHaveBeenCalled();\n\n            const $anchor = $el.children('.comment-anchor');\n            expect($anchor.length).toBe(1);\n            expect($anchor.attr('name')).toBe('header-reply121');\n\n            const $floatingAnchor = $el.find('> .floating-anchor > a');\n            expect($floatingAnchor.length).toBe(1);\n            expect($floatingAnchor.attr('href')).toBe('#header-reply121');\n            expect($floatingAnchor.hasClass('fa fa-link fa-flip-horizontal'))\n                .toBe(true);\n        });\n    });\n\n    describe('Methods', function() {\n        it('openCommentEditor', function() {\n            view.render();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(true);\n            expect(view._$draftComment).toBe(null);\n\n            view.openCommentEditor();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(false);\n            expect(view._$draftComment).not.toBe(null);\n            expect(view._$draftComment.hasClass('draft')).toBe(true);\n        });\n    });\n\n    describe('Text rendering', function() {\n        function testRendering(richText, expectedHTML) {\n            view.render();\n\n            const $comment = view._makeCommentElement({\n                text: '<p><strong>Test</strong> &amp;lt;</p>',\n                richText: richText,\n            });\n\n            const $reviewText = $comment.find('.reviewtext');\n            expect($reviewText.length).toBe(1);\n            expect($reviewText.hasClass('rich-text')).toBe(richText);\n            expect($reviewText.html()).toBe(expectedHTML);\n        }\n\n        it('richText=true', function() {\n            testRendering(true, '<p><strong>Test</strong> &amp;lt;</p>');\n        });\n\n        it('richText=false', function() {\n            testRendering(false,\n                          '&lt;p&gt;&lt;strong&gt;Test&lt;/strong&gt; ' +\n                          '&amp;amp;lt;&lt;/p&gt;');\n        });\n    });\n});\n"],"mappings":";;AAAAA,KAAK,CAAC,kDAAkD,EAAE,YAAW;EACjE,IAAIC,WAAW;EACf,IAAIC,MAAM;EACV,IAAIC,IAAI;EAERC,UAAU,CAAC,YAAW;IAClB,MAAMC,UAAU,GAAGC,CAAC,CAAC,QAAQ,CAAC,CAACC,QAAQ,CAACC,aAAa,CAAC;IAEtDP,WAAW,GAAG,IAAIQ,EAAE,CAACC,WAAW,CAAC;MAC7BC,EAAE,EAAE;IACR,CAAC,CAAC;;IAEF;IACAC,KAAK,CAACX,WAAW,EAAE,gBAAgB,CAAC,CAACY,GAAG,CAACC,QAAQ,CAC7C,CAACC,OAAO,EAAEC,OAAO,KAAKD,OAAO,CAACE,OAAO,CAACC,IAAI,CAACF,OAAO,CAAC,CAAC;IAExDd,MAAM,GAAG,IAAIO,EAAE,CAACU,iBAAiB,CAACC,iBAAiB,CAAC;MAChDC,YAAY,EAAE,cAAc;MAC5BC,WAAW,EAAErB,WAAW;MACxBsB,MAAM,EAAE,IAAId,EAAE,CAACe,MAAM,CAAC;QAClBb,EAAE,EAAE,EAAE;QACNc,YAAY,EAAE,IAAIhB,EAAE,CAACiB,aAAa,CAAC;MACvC,CAAC,CAAC;MACFzB,WAAW,EAAEA,WAAW;MACxB0B,WAAW,EAAE,MAAM;MACnBC,SAAS,EAAE;IACf,CAAC,CAAC;IAEFzB,IAAI,GAAG,IAAIM,EAAE,CAACU,iBAAiB,CAACU,qBAAqB,CAAC;MAClDC,KAAK,EAAE5B,MAAM;MACb6B,EAAE,EAAEvB;IACR,CAAC,CAAC;;IAEF;IACAL,IAAI,CAAC6B,cAAc,GAAG1B,CAAC,CAAC,8BAA8B,CAAC;IAEvDD,UAAU,CACL4B,MAAM,CAAC9B,IAAI,CAAC6B,cAAc,CAAC,CAC3BC,MAAM,CAAC3B,CAAC,CAAC,sDAAsD,CAAC,CAAC;EAC1E,CAAC,CAAC;EAEF4B,QAAQ,CAAC,cAAc,EAAE,YAAW;IAChCC,EAAE,CAAC,6BAA6B,EAAE,YAAW;MACzC,MAAMC,WAAW,GAAG,cAAc;MAClC,MAAMC,GAAG,GAAGC,MAAM,CAAC,CAAC;MACpB,MAAMC,GAAG,GAAGpC,IAAI,CAACqC,mBAAmB,CAAC;QACjCC,SAAS,EAAE,EAAE;QACbJ,GAAG,EAAEA,GAAG;QACRK,IAAI,EAAEN;MACV,CAAC,CAAC;MAEFjC,IAAI,CAACwC,MAAM,CAAC,CAAC;MAEbC,MAAM,CAAC1C,MAAM,CAAC2C,GAAG,CAAC,WAAW,CAAC,CAAC,CAACC,IAAI,CAAC,EAAE,CAAC;MACxCF,MAAM,CAAC1C,MAAM,CAAC2C,GAAG,CAAC,MAAM,CAAC,CAAC,CAACC,IAAI,CAACV,WAAW,CAAC;MAC5CQ,MAAM,CAAC1C,MAAM,CAAC2C,GAAG,CAAC,UAAU,CAAC,CAAC,CAACC,IAAI,CAAC,IAAI,CAAC;MACzCF,MAAM,CAAC1C,MAAM,CAAC2C,GAAG,CAAC,WAAW,CAAC,CAACE,OAAO,CAAC,CAAC,CAAC,CACpCD,IAAI,CAACT,GAAG,CAACW,YAAY,CAAC,CAAC,CAAC,CAACD,OAAO,CAAC,CAAC,CAAC;MACxCH,MAAM,CAACzC,IAAI,CAAC8C,cAAc,CAAC,CAAC,CAAC,CAAC,CAACH,IAAI,CAACP,GAAG,CAAC,CAAC,CAAC,CAAC;MAC3CK,MAAM,CAACzC,IAAI,CAAC+C,gBAAgB,CAACC,EAAE,CAAC,UAAU,CAAC,CAAC,CAACL,IAAI,CAAC,KAAK,CAAC;IAC5D,CAAC,CAAC;EACN,CAAC,CAAC;EAEFZ,QAAQ,CAAC,SAAS,EAAE,YAAW;IAC3BC,EAAE,CAAC,kBAAkB,EAAE,YAAW;MAC9BhC,IAAI,CAACwC,MAAM,CAAC,CAAC;MAEbC,MAAM,CAACzC,IAAI,CAAC+C,gBAAgB,CAACC,EAAE,CAAC,UAAU,CAAC,CAAC,CAACL,IAAI,CAAC,IAAI,CAAC;MACvD3C,IAAI,CAAC+C,gBAAgB,CAACE,KAAK,CAAC,CAAC;MAE7BR,MAAM,CAACzC,IAAI,CAAC+C,gBAAgB,CAACC,EAAE,CAAC,UAAU,CAAC,CAAC,CAACL,IAAI,CAAC,KAAK,CAAC;MACxDF,MAAM,CAACzC,IAAI,CAAC8C,cAAc,CAAC,CAACI,GAAG,CAACP,IAAI,CAAC,IAAI,CAAC;MAC1CF,MAAM,CAACzC,IAAI,CAAC8C,cAAc,CAACK,QAAQ,CAAC,OAAO,CAAC,CAAC,CAACR,IAAI,CAAC,IAAI,CAAC;IAC5D,CAAC,CAAC;EACN,CAAC,CAAC;EAEFZ,QAAQ,CAAC,gBAAgB,EAAE,YAAW;IAClCC,EAAE,CAAC,mBAAmB,EAAE,YAAW;MAC/BhC,IAAI,CAACqC,mBAAmB,CAAC;QACrBE,IAAI,EAAE;MACV,CAAC,CAAC;MAEFvC,IAAI,CAACwC,MAAM,CAAC,CAAC;MAEb,IAAIJ,GAAG,GAAGpC,IAAI,CAACG,CAAC,CAAC,oBAAoB,CAAC;MACtCsC,MAAM,CAACL,GAAG,CAACgB,MAAM,CAAC,CAACT,IAAI,CAAC,CAAC,CAAC;MAE1B7C,WAAW,CAACuD,OAAO,CAAC,WAAW,CAAC;MAEhCjB,GAAG,GAAGpC,IAAI,CAACG,CAAC,CAAC,oBAAoB,CAAC;MAClCsC,MAAM,CAACL,GAAG,CAACgB,MAAM,CAAC,CAACT,IAAI,CAAC,CAAC,CAAC;MAC1BF,MAAM,CAACzC,IAAI,CAAC8C,cAAc,CAAC,CAACH,IAAI,CAAC,IAAI,CAAC;IAC1C,CAAC,CAAC;IAEFX,EAAE,CAAC,mBAAmB,EAAE,YAAW;MAC/B,MAAMsB,QAAQ,GAAGtD,IAAI,CAACqC,mBAAmB,CAAC;QACtCC,SAAS,EAAE;MACf,CAAC,CAAC;MAEF7B,KAAK,CAACN,CAAC,CAACoD,EAAE,EAAE,cAAc,CAAC,CAAC7C,GAAG,CAAC8C,WAAW,CAAC,CAAC;MAC7C/C,KAAK,CAACN,CAAC,CAACoD,EAAE,EAAE,WAAW,CAAC,CAAC7C,GAAG,CAAC8C,WAAW,CAAC,CAAC;MAE1CxD,IAAI,CAACwC,MAAM,CAAC,CAAC;MACbzC,MAAM,CAAC0D,GAAG,CAAC,MAAM,EAAE,kBAAkB,CAAC;MACtC3D,WAAW,CAACuD,OAAO,CAAC,WAAW,CAAC;MAEhC,MAAMjB,GAAG,GAAGpC,IAAI,CAACG,CAAC,CAAC,oBAAoB,CAAC;MAExCsC,MAAM,CAACL,GAAG,CAACgB,MAAM,CAAC,CAACT,IAAI,CAAC,CAAC,CAAC;MAC1BF,MAAM,CAACa,QAAQ,CAAC,CAACJ,GAAG,CAACP,IAAI,CAACP,GAAG,CAAC;MAC9BK,MAAM,CAACL,GAAG,CAACe,QAAQ,CAAC,OAAO,CAAC,CAAC,CAACR,IAAI,CAAC,KAAK,CAAC;MACzCF,MAAM,CAACL,GAAG,CAACsB,IAAI,CAAC,YAAY,CAAC,CAAC,CAACf,IAAI,CAAC,EAAE,CAAC;MACvCF,MAAM,CAACzC,IAAI,CAAC8C,cAAc,CAAC,CAACH,IAAI,CAAC,IAAI,CAAC;MACtCF,MAAM,CAACtC,CAAC,CAACoD,EAAE,CAACI,YAAY,CAAC,CAACC,gBAAgB,CAAC,CAAC;MAC5CnB,MAAM,CAACtC,CAAC,CAACoD,EAAE,CAACM,SAAS,CAAC,CAACD,gBAAgB,CAAC,CAAC;MAEzC,MAAME,OAAO,GAAG1B,GAAG,CAAC2B,QAAQ,CAAC,iBAAiB,CAAC;MAC/CtB,MAAM,CAACqB,OAAO,CAACV,MAAM,CAAC,CAACT,IAAI,CAAC,CAAC,CAAC;MAC9BF,MAAM,CAACqB,OAAO,CAACE,IAAI,CAAC,MAAM,CAAC,CAAC,CAACrB,IAAI,CAAC,iBAAiB,CAAC;MAEpD,MAAMsB,eAAe,GAAG7B,GAAG,CAAC8B,IAAI,CAAC,wBAAwB,CAAC;MAC1DzB,MAAM,CAACwB,eAAe,CAACb,MAAM,CAAC,CAACT,IAAI,CAAC,CAAC,CAAC;MACtCF,MAAM,CAACwB,eAAe,CAACD,IAAI,CAAC,MAAM,CAAC,CAAC,CAACrB,IAAI,CAAC,kBAAkB,CAAC;MAC7DF,MAAM,CAACwB,eAAe,CAACd,QAAQ,CAAC,+BAA+B,CAAC,CAAC,CAC5DR,IAAI,CAAC,IAAI,CAAC;IACnB,CAAC,CAAC;EACN,CAAC,CAAC;EAEFZ,QAAQ,CAAC,SAAS,EAAE,YAAW;IAC3BC,EAAE,CAAC,mBAAmB,EAAE,YAAW;MAC/BhC,IAAI,CAACwC,MAAM,CAAC,CAAC;MAEbC,MAAM,CAACzC,IAAI,CAAC+C,gBAAgB,CAACC,EAAE,CAAC,UAAU,CAAC,CAAC,CAACL,IAAI,CAAC,IAAI,CAAC;MACvDF,MAAM,CAACzC,IAAI,CAAC8C,cAAc,CAAC,CAACH,IAAI,CAAC,IAAI,CAAC;MAEtC3C,IAAI,CAACmE,iBAAiB,CAAC,CAAC;MAExB1B,MAAM,CAACzC,IAAI,CAAC+C,gBAAgB,CAACC,EAAE,CAAC,UAAU,CAAC,CAAC,CAACL,IAAI,CAAC,KAAK,CAAC;MACxDF,MAAM,CAACzC,IAAI,CAAC8C,cAAc,CAAC,CAACI,GAAG,CAACP,IAAI,CAAC,IAAI,CAAC;MAC1CF,MAAM,CAACzC,IAAI,CAAC8C,cAAc,CAACK,QAAQ,CAAC,OAAO,CAAC,CAAC,CAACR,IAAI,CAAC,IAAI,CAAC;IAC5D,CAAC,CAAC;EACN,CAAC,CAAC;EAEFZ,QAAQ,CAAC,gBAAgB,EAAE,YAAW;IAClC,SAASqC,aAAaA,CAACC,QAAQ,EAAEC,YAAY,EAAE;MAC3CtE,IAAI,CAACwC,MAAM,CAAC,CAAC;MAEb,MAAM+B,QAAQ,GAAGvE,IAAI,CAACqC,mBAAmB,CAAC;QACtCE,IAAI,EAAE,uCAAuC;QAC7C8B,QAAQ,EAAEA;MACd,CAAC,CAAC;MAEF,MAAMG,WAAW,GAAGD,QAAQ,CAACL,IAAI,CAAC,aAAa,CAAC;MAChDzB,MAAM,CAAC+B,WAAW,CAACpB,MAAM,CAAC,CAACT,IAAI,CAAC,CAAC,CAAC;MAClCF,MAAM,CAAC+B,WAAW,CAACrB,QAAQ,CAAC,WAAW,CAAC,CAAC,CAACR,IAAI,CAAC0B,QAAQ,CAAC;MACxD5B,MAAM,CAAC+B,WAAW,CAACC,IAAI,CAAC,CAAC,CAAC,CAAC9B,IAAI,CAAC2B,YAAY,CAAC;IACjD;IAEAtC,EAAE,CAAC,eAAe,EAAE,YAAW;MAC3BoC,aAAa,CAAC,IAAI,EAAE,uCAAuC,CAAC;IAChE,CAAC,CAAC;IAEFpC,EAAE,CAAC,gBAAgB,EAAE,YAAW;MAC5BoC,aAAa,CAAC,KAAK,EACL,6CAA6C,GAC7C,wBAAwB,CAAC;IAC3C,CAAC,CAAC;EACN,CAAC,CAAC;AACN,CAAC,CAAC"}