{"version":3,"file":"draftResourceModelMixin.js","names":["RB","DraftResourceModelMixin","ready","options","context","undefined","_","isFunction","success","error","complete","console","warn","promiseToCallbacks","newOptions","get","isNew","_needDraft","_super","call","_retrieveDraft","destroy","url","parentObject","linkName","result","links","href","$","now","UserSession","instance","Promise","reject","BackboneError","errorText","gettext","data","extraQueryArgs","isEmpty","extend","resolve","Backbone","Model","prototype","fetch","processData","model","xhr","status"],"sources":["../../../../../../static/rb/js/resources/models/draftResourceModelMixin.es6.js"],"sourcesContent":["/**\n * Mixin for resources that have special \"draft\" URLs.\n *\n * Some resources contain a \"draft/\" singleton URL that will either redirect to\n * the URL for an existing draft, or indicate there's no draft (and requiring\n * that one be created).\n *\n * These resources need a little more logic to look up the draft state and\n * craft the proper URL. They can use this mixin to do that work for them.\n */\nRB.DraftResourceModelMixin = {\n    /**\n     * Call a function when the object is ready to use.\n     *\n     * If the object is unloaded, we'll likely need to grab the draft\n     * resource, particularly if we haven't already retrieved a draft.\n     *\n     * Otherwise, we delegate to the parent's ready().\n     *\n     * Version Changed:\n     *     5.0:\n     *     Deprecated callbacks and changed to return a promise.\n     *\n     * Args:\n     *     options (object, optional):\n     *         Options for the operation, including callbacks.\n     *\n     *     context (object, optional):\n     *         Context to bind when calling callbacks.\n     *\n     * Returns:\n     *     Promise:\n     *     A promise which resolves when the operation is complete.\n     */\n    async ready(options={}, context=undefined) {\n        if (_.isFunction(options.success) ||\n            _.isFunction(options.error) ||\n            _.isFunction(options.complete) ||\n            _.isFunction(options.ready)) {\n            console.warn('RB.DraftResourceModelMixin.ready was ' +\n                         'called using callbacks. Callers should be updated ' +\n                         'to use promises instead.');\n            return RB.promiseToCallbacks(\n                options, context, newOptions => this.ready(newOptions));\n        }\n\n        if (!this.get('loaded') && this.isNew() &&\n            this._needDraft === undefined) {\n            this._needDraft = true;\n        }\n\n        await _super(this).ready.call(this);\n\n        if (this._needDraft) {\n            /*\n             * Start by delegating to the parent ready() function. Because the\n             * object is \"new\", this will make sure that the parentObject is\n             * ready.\n             */\n            await this._retrieveDraft(options);\n        }\n    },\n\n    /**\n     * Destroy the object.\n     *\n     * If destruction is successful, we'll reset the needDraft state so we'll\n     * look up the draft the next time an operation is performed.\n     *\n     * Version Changed:\n     *     5.0:\n     *     Deprecated callbacks and changed to return a promise.\n     *\n     * Args:\n     *     options (object, optional):\n     *         Options for the operation, including callbacks.\n     *\n     *     context (object, optional):\n     *         Context to bind when calling callbacks.\n     *\n     * Returns:\n     *     Promise:\n     *     A promise which resolves when the operation is complete.\n     */\n    async destroy(options={}, context=undefined) {\n        if (_.isFunction(options.success) ||\n            _.isFunction(options.error) ||\n            _.isFunction(options.complete)) {\n            console.warn('RB.DraftResourceModelMixin.destroy was ' +\n                         'called using callbacks. Callers should be updated ' +\n                         'to use promises instead.');\n            return RB.promiseToCallbacks(\n                options, context, newOptions => this.destroy(newOptions));\n        }\n\n        await this.ready();\n        await _super(this).destroy.call(this, options);\n\n        /* We need to fetch the draft resource again. */\n        this._needDraft = true;\n    },\n\n    /**\n     * Return the URL to use when syncing the model.\n     *\n     * Custom URL implementation which will return the special draft resource\n     * if we have yet to redirect and otherwise delegate to the prototype\n     * implementation.\n     *\n     * Returns:\n     *     string:\n     *     The URL to use for the resource.\n     */\n    url() {\n        if (this._needDraft) {\n            const parentObject = this.get('parentObject');\n            const linkName = _.result(this, 'listKey');\n            const links = parentObject.get('links');\n\n            /*\n             * Chrome hyper-aggressively caches things it shouldn't, and\n             * appears to do so in a subtly broken way.\n             *\n             * If we do a DELETE on a reply's URL, then later a GET (resulting\n             * from a redirect from a GET to draft/), Chrome will somehow get\n             * confused and associate the GET's caching information with a 404.\n             *\n             * In order to prevent this, we need to make requests to draft/\n             * appear unique. We can do this by appending the timestamp here.\n             * Chrome will no longer end up with broken state for our later\n             * GETs.\n             *\n             * Much of this is only required in the case of sqlite, which,\n             * with Django, may reuse row IDs, causing problems when making\n             * a reply, deleting, and making a new one. In production, this\n             * shouldn't be a problem, but it's very confusing during\n             * development.\n             */\n            return links[linkName].href + 'draft/?' + $.now();\n        } else {\n            return _super(this).url.call(this);\n        }\n    },\n\n    /**\n     * Try to retrieve an existing draft from the server.\n     *\n     * This uses the special draft/ resource within the resource list, which\n     * will redirect to an existing draft if one exists.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the operation, including callbacks.\n     */\n    _retrieveDraft(options) {\n        if (!RB.UserSession.instance.get('authenticated')) {\n            return Promise.reject(new BackboneError(\n                this,\n                { errorText: gettext('You must be logged in to retrieve the draft.') },\n                {}));\n        }\n\n        let data = options.data || {};\n        const extraQueryArgs = _.result(this, 'extraQueryArgs', {});\n\n        if (!_.isEmpty(extraQueryArgs)) {\n            data = _.extend({}, extraQueryArgs, data);\n        }\n\n        return new Promise((resolve, reject) => {\n            Backbone.Model.prototype.fetch.call(this, {\n                data: data,\n                processData: true,\n                success: () => {\n                    /*\n                     * There was an existing draft, and we were redirected to it\n                     * and pulled data from it. We're done.\n                     */\n                    this._needDraft = false;\n\n                    resolve();\n                },\n                error: (model, xhr, options) => {\n                    if (xhr.status === 404) {\n                        /*\n                         * We now know we don't have an existing draft to work with,\n                         * and will eventually need to POST to create a new one.\n                         */\n                        this._needDraft = false;\n                        resolve();\n                    } else {\n                        reject(new BackboneError(model, xhr, options));\n                    }\n                }\n            });\n        });\n    },\n};\n"],"mappings":"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"}