import{C as V,_ as j}from"./ChatRecprdsHeader-SD-RUt6E.js";import{h as U}from"./axios-jGQk5ZQo.js";import{d as $,o as r,c as u,a as t,t as k,_ as M,r as h,b as N,e as f,f as _,u as R,i as I,w as q,g as y,h as B,j as L,F as E,k as F,n as H,l as D,H as z}from"./index-FGVSFSnI.js";const P={class:"chat-content"},A={key:0,class:"word"},W=["src"],G={class:"info"},J={class:"time"},K=["innerHTML"],Q={key:1,class:"word-my"},X={class:"info"},Y={class:"time"},Z=["innerHTML"],ee=["src"],te=$({__name:"MessageText",props:{is_sender:{type:Number,default:0},content:{type:String,default:""},headUrl:{type:String,default:""},direction:{type:String,default:""}},setup(e){const i=s=>(s=s.replace(/\n/g,"<br>"),new DOMParser().parseFromString(s,"text/html").body.innerHTML);return(s,n)=>(r(),u("div",P,[e.is_sender?(r(),u("div",Q,[t("div",X,[t("p",Y,k(e.direction),1),t("div",{class:"info-content",innerHTML:i(e.content)},null,8,Z)]),t("img",{src:e.headUrl},null,8,ee)])):(r(),u("div",A,[t("img",{src:e.headUrl},null,8,W),t("div",G,[t("p",J,k(e.direction),1),t("div",{class:"info-content",innerHTML:i(e.content)},null,8,K)])]))]))}}),ae=M(te,[["__scopeId","data-v-d930be9e"]]),se={class:"chat-content"},ne={key:0,class:"word"},re=["src"],oe={class:"info"},ce={class:"time"},le={class:"demo-image__preview"},ie={key:1,class:"word-my"},de={class:"info"},ue={class:"time"},_e={class:"demo-image__preview"},he=["src"],ve=$({__name:"MessageImg",props:{is_sender:{type:Number,default:0},content:{type:String,default:""},headUrl:{type:String,default:""},direction:{type:String,default:""},src:{type:String,default:""}},setup(e){const i=e,s=h("");N(async()=>{s.value=await n(i.src)});const n=async c=>{try{return await U.post("/api/img",{img_path:c})}catch(v){return console.error("Error fetching data:",v),""}};return(c,v)=>{const m=f("el-image");return r(),u("div",se,[e.is_sender?(r(),u("div",ie,[t("div",de,[t("p",ue,k(e.direction),1),t("div",_e,[_(m,{style:{"max-width":"150px","max-height":"150px"},src:s.value,"zoom-rate":1.2,"max-scale":7,"min-scale":.2,"preview-src-list":[s.value],"initial-index":4,fit:"cover"},null,8,["src","preview-src-list"])])]),t("img",{src:e.headUrl},null,8,he)])):(r(),u("div",ne,[t("img",{src:e.headUrl},null,8,re),t("div",oe,[t("p",ce,k(e.direction),1),t("div",le,[_(m,{style:{"max-width":"150px","max-height":"150px"},src:s.value,"zoom-rate":1.2,"max-scale":7,"min-scale":.2,"preview-src-list":[s.value],"initial-index":4,fit:"cover"},null,8,["src","preview-src-list"])])])]))])}}}),me=M(ve,[["__scopeId","data-v-2190d708"]]),fe={class:"chat-content"},pe={key:0,class:"word"},ye=["src"],ge={class:"info"},we={class:"time"},ke={controls:"",style:{"background-color":"#fff"}},$e=["src"],xe={key:1,class:"word-my"},be={class:"info"},Se={class:"time"},Te={controls:"",style:{"background-color":"#95EC69"}},De=["src"],Me=["src"],Ue=$({__name:"MessageAudio",props:{is_sender:{type:Number,default:0},headUrl:{type:String,default:""},direction:{type:String,default:""},src:{type:String,default:""},msg:{type:String,default:""}},setup(e){return(i,s)=>(r(),u("div",fe,[e.is_sender?(r(),u("div",xe,[t("div",be,[t("p",Se,k(e.direction),1),t("audio",Te,[t("source",{src:e.src,type:"audio/wav"},null,8,De)]),_(R(I),{rows:1,readonly:!0,value:e.msg,style:{width:"100%"}},null,8,["value"])]),t("img",{src:e.headUrl},null,8,Me)])):(r(),u("div",pe,[t("img",{src:e.headUrl},null,8,ye),t("div",ge,[t("p",we,k(e.direction),1),t("audio",ke,[t("source",{src:e.src,type:"audio/wav"},null,8,$e)]),_(R(I),{rows:1,readonly:!0,value:e.msg,style:{width:"100%"}},null,8,["value"])])]))]))}}),He=M(Ue,[["__scopeId","data-v-0d0f2cd4"]]),Ce={id:"chat"},Re={class:"chat_body"},Ie={class:"chat_window",ref:"chatWindow"},Le={key:0,class:"load_more",style:{display:"flex","justify-content":"center","margin-top":"10px","margin-bottom":"10px"}},Ne=$({__name:"ChatRecordsMain",props:{userData:{type:Object,required:!0},setScrollTop:{type:Function,required:!0},updateScrollTop:{type:Function,required:!0}},setup(e,{expose:i}){const s=e,n=h([]),c=h({}),v=h(""),m=h(50),l=h(0),g=h(!1),x=async(o,p,d)=>{try{const a=await U.post("/api/msgs",{start:o,limit:p,wxid:d});return n.value=a.msg_list,c.value=a.user_list,v.value=a.my_wxid,a}catch(a){return console.error("Error fetching data:",a),[]}},T=async()=>{try{l.value=s.userData.chat_count-m.value,await x(l.value,m.value,s.userData.username),g.value||await H(()=>{s.setScrollTop(),g.value=!1})}catch(o){return console.error("Error fetching data:",o),[]}};N(T),q(()=>s.userData.username,(o,p)=>{n.value=[],g.value=!1,T()});const b=o=>(o.talker=="我"&&(o.talker=v.value),`${(d=>c.value.hasOwnProperty(d.talker)?c.value[d.talker].remark?c.value[d.talker].remark:c.value[d.talker].nickname?c.value[d.talker].nickname:c.value[d.talker].account?c.value[d.talker].account:d.talker:d.talker)(o)} [${o.type_name}] ${o.CreateTime}`),S=o=>(o.talker=="我"&&(o.talker=v.value),c.value.hasOwnProperty(o.talker)?c.value[o.talker].headImgUrl:""),C=async()=>{let o=m.value,p=l.value-o;const d=await U.post("/api/msgs",{start:p,limit:o,wxid:s.userData.username});l.value=p,n.value=d.msg_list.concat(n.value),n.value.sort((a,w)=>a.id-w.id),n.value=n.value.filter((a,w,O)=>w===0||a.id!==O[w-1].id),c.value=Object.assign(c.value,d.user_list),await H(()=>{s.updateScrollTop()})};return i({loadMore:C}),(o,p)=>{const d=f("el-button");return r(),u("div",Ce,[t("div",Re,[t("div",Ie,[n.value.length<e.userData.chat_count?(r(),u("div",Le,[_(d,{type:"primary",onClick:C},{default:y(()=>[B("查看更多消息")]),_:1})])):L("",!0),(r(!0),u(E,null,F(n.value,(a,w)=>(r(),u("div",{class:"message",key:w},[a.type_name=="文本"?(r(),D(ae,{key:0,is_sender:a.is_sender,direction:b(a),headUrl:S(a),content:a.content.msg},null,8,["is_sender","direction","headUrl","content"])):a.type_name=="图片"?(r(),D(me,{key:1,is_sender:a.is_sender,direction:b(a),headUrl:S(a),src:a.content.src},null,8,["is_sender","direction","headUrl","src"])):a.type_name=="语音"?(r(),D(He,{key:2,is_sender:a.is_sender,direction:b(a),headUrl:S(a),src:"api/"+a.content.src,msg:a.content.msg},null,8,["is_sender","direction","headUrl","src","msg"])):L("",!0)]))),128))],512)])])}}}),Oe=M(Ne,[["__scopeId","data-v-978e4e80"]]),Ve=$({__name:"ChatRecords",props:{userData:{type:Object,required:!0}},setup(e){const i=h(null),s=h(null);h(0);const n=h(0),c=()=>{H(()=>{if(i.value){const l=i.value.$el.children[0];l&&(l.scrollTop=l.scrollHeight,n.value=l.scrollHeight)}})},v=()=>{const l=i.value.$el.children[0];if(l){const g=n.value,x=l.scrollHeight-g;l.scrollTop=l.scrollTop+x,n.value=l.scrollHeight}};function m({scrollTop:l}){l===0&&s.value&&s.value.loadMore()}return(l,g)=>{const x=f("el-header"),T=f("el-scrollbar"),b=f("el-main"),S=f("el-container");return r(),D(S,null,{default:y(()=>[_(x,{style:{height:"65px","max-height":"65px",width:"100%","background-color":"#d2d2fa","padding-top":"5px"}},{default:y(()=>[_(V,{userData:e.userData},null,8,["userData"])]),_:1}),_(b,{style:{"overflow-y":"auto",height:"calc(100vh - 65px)",padding:"0"}},{default:y(()=>[_(T,{ref_key:"scrollbarRef",ref:i,onScroll:m},{default:y(()=>[_(Oe,{ref_key:"chatRecordsMainRef",ref:s,userData:e.userData,setScrollTop:c,updateScrollTop:v},null,8,["userData"])]),_:1},512)]),_:1})]),_:1})}}}),je={id:"chat_view",class:"common-layout"},qe={key:0,style:{height:"calc(100vh)",width:"100%"}},Be={key:1,style:{width:"100%",height:"100%"}},Pe=$({__name:"ChatView",setup(e){const i=h({account:"",describe:"",headImgUrl:"",nickname:"",remark:"",username:"",chat_count:0}),s=n=>{i.value=n};return(n,c)=>{const v=f("el-aside"),m=f("el-container");return r(),u("div",je,[_(m,null,{default:y(()=>[_(v,{width:"266px",style:{"overflow-y":"auto",height:"calc(100vh)"}},{default:y(()=>[_(j,{onUserData:s})]),_:1}),i.value.username!=""?(r(),u("div",qe,[_(Ve,{userData:i.value},null,8,["userData"])])):(r(),u("div",Be,[_(z)]))]),_:1})])}}});export{Pe as default};
