<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="UTF-8">
    <style>
		body {
		    margin: 2rem;
		}
		
		h2 {
		    border-bottom: 1px solid #b3c0c8;
		}
		h3 {
		    border-bottom: 5px solid #f5f1ff;
		}        
		
		#footer {
		    margin-top: 4rem;
		    color: gray;
		    border-top: 2px solid #ddd;
		    text-align: center;
		}
		
		code {
		    color: green;
		}
		
		.info-icon {
		    float: right;
		    background-color: #3175f7;
		    width: 1.0rem;
		    height: 1rem;
		    padding: 0.1rem;
		    text-align: center;
		    padding-bottom: 0rem;
		    color: white;
		    font-weight: bold;
		    border-radius: 1rem;
		    line-height: 11pt;
		    cursor: pointer;
		}
		.info-line {
		    width: 100%;
		    background-color: whitesmoke;
		    padding: 1rem;
		    margin: 1rem;
		    margin-left: -1rem;
		    font-size: 10pt;
		}
		
		.optional {
		    margin: 1rem;
		    border: 1px dotted #375fd4;
		    padding: 1rem;
		    background-color: #e6efff;
		}
		
		.annotation {
		    margin: 0.3rem;
		    padding: 0.3rem;
		}
		  
		label {
		    margin-left: 0.3rem;
		    margin-right: 0.3rem;
		}
		
		.hide,
		.hidden {
		    display: none
		}
		
		.spacer-1 {
		    margin: 0rem;
		    padding:0rem;
		}
		.spacer-2 {
		    margin: 0rem;
		    padding:0rem;
		}
		.spacer-3 {
		    margin: 0rem;
		    padding:0rem;
		}
		.spacer-4 {
		    margin: 0rem;
		    padding:0rem;
		}
		.flex-row {
		    display: flex;
		    flex-direction: row;
		    margin-bottom: 0.5rem;
		}
		.flex-row>.annotation {
		    flex: 4;
		}
		.flex-row>div.label {
		    flex: 1;
		}
		.flex-row>.spacer-1 {
		    flex: 1;
		}  
		.flex-row>.spacer-2 {
		    flex: 2;
		}  
		.flex-row>.spacer-3 {
		    flex: 3;
		}  
		.flex-row>.spacer-4 {
		    flex: 4;
		}                                
		.flex-row>input {
		    flex: auto;
		}        
		.flex-row>button {
		    flex: 1;
		} 
		#pywebview-status {
		    position: absolute;
		    top: 0rem;
		    right: 1rem;
		}
		
		#response-container {
		    display: none;
		    padding: 3rem;
		    margin: 3rem 5rem;
		    font-size: 12pt;
		    border: 5px dashed #ccc;
		}
		
		.code-0 {
		    color: gray
		}
		
		.code-405 {
		    color: rgb(237, 10, 10);
		
		}
		
		.code-500 {
		    color: rgb(237, 10, 10);
		    font-weight: bold;
		}
		
		.code-500::before {
		    content: 'Internal Error: ';
		}
		
		.blink_me {
		    animation: blinker 1s linear infinite;
		}
		
		@keyframes blinker {
		    50% {
		        opacity: 0;
		        color: rgb(237, 10, 10);
		    }
		}
		
		.done {
		    background-color: #e9ffdf;
		    color: #14440a;
		    border: 1px dotted #248a07;
		}
		.action-link {
		    color: blue;
		    text-decoration: underline;
		    cursor: pointer;
		}
		
		button {
		    font-size: 10pt;
		    margin: 0.3rem;
		    background-color: #0a365d;
		    border: 0px solid #fff;
		    color: white;
		    font-weight: normal;
		    border-radius: 0.4rem;
		    cursor: pointer;
		}
		.bottom {
		    margin-left: -2rem;
		    width: calc(100vw);
		    position: fixed;
		    bottom: -0.3rem;
		    border-top: 1px solid #9090a4;
		}    
		
		#footer button {
		    padding: 1rem;
		    display: block;
		    width: 100%;
		    border-radius: 0;
		    padding-top: 0.3rem;
		    padding-bottom: 0.3rem;
		    background-color: #c8c8d9;
		    color: #191d59;
		}
		#footer button.bottom {
		    padding: 0.5rem;
		}
		
		#footer button.done {
		    background-color: #e0eeb9;
		    color: #14440a;
		}
		div.done button {
		    background-color: #bae5ab;
		    color: #14440a;
		}
		
		
		#error-box {
		    width: 100vw;
		    background-color: #090909d1;
		    position: absolute;
		    top: 80vh;
		    left: 0;
		    height: 20vh;
		    overflow-y: scroll;
		}
		.close-error-box {
		    width: 16px;
		    float: right;
		    font-family: sans;
		    color: white;
		    cursor: pointer;
		    font-size: 10pt;
		    border: 1px solid white;
		    text-align: center;
		}
		#error-list {
		    margin: 1rem;
		    color: white;
		    font-family: sans;
		    font-size: 10pt;
		}
		

	</style>
    <script>
        let WINDOW_ID = '{{window_id}}'
        let load_list = []
    </script>
</head>

<body>
    <h1>Template {{window_id}}</h1>
    <div id="outnull"></div>
    <p id='pywebview-status'><span class="blink_me">Initializing...</span></p>
    <div id="error-box" class="hidden">
        <div class="close-error-box" onclick="this.parentElement.classList.add('hidden');">x</div>
        <div id="error-list"></div>
    </div>

    	<div class="flex-row">
	    <button onClick="getVaultPath()">Select vault</button><br />
	    <div class="annotation" id="current-vault-path">None selected</div>
	    <div class="info-icon" onClick="toggle('info-select-vault-path')">i</div>
	</div>
	<div class="info-line" id="info-select-vault-path" style="display: none;">
	    Your Obsidian Vault folder. Select the first (sub)folder that by itself contains all the notes in your vault.
	</div>
	
	<script>
	    // register
	    load_list.push({
	        'id': 'vault_path',
	        'div_id': 'current-vault-path',
	    })
	    
	    // button action
	    function getVaultPath(){
	        input = {
	            'action':'action/get_vault_path',
	            'window_id': WINDOW_ID,
	            'result_div_id': 'current-vault-path'
	        }
	        coreOnClick();
	        pywebview.api.call(input).then(showResponse).catch(showResponse)
	    }
	</script>

    	
	<div class="">
	    <div class="flex-row">
	        <button onClick="getEntrypointPath('set-entrypoint-path1')">Select entrypoint note</button>
	        <div class="annotation" id="set-entrypoint-path1">None selected</div>
	        <div class="info-icon" onClick="toggle('info-select-entrypoint-path1')">i</div>
	    </div>
	    <div class="info-line" id="info-select-entrypoint-path1" style="display: none;">
	        The note that is to become the homepage of your new site. 
	        In default mode, ObsidianHtml will start compiling your website starting with this node, and following any links to any other note.
	        This note has to be in the vault selected above.
	    </div> 
	</div>
	
	<div class="hide">
	    <div class="flex-row">
	        <div class="spacer-2">Entrypoint</div>
	        <div class="spacer-4" id="summary-entrypoint-path1">Failed to load setting</div>
	        <div class="info-icon" onClick="toggle('info-summary-entrypoint-path1')">i</div>
	    </div>
	    <div class="info-line" id="info-summary-entrypoint-path1" style="display: none;">
	        The note that is to become the homepage of your new site. 
	        In default mode, ObsidianHtml will start compiling your website starting with this note, and following any links to any other note.
	        This note has to be in the vault selected above.
	    </div>
	</div>
	
	<script>
	    // register
	    load_list.push({
	        'id': 'entrypoint_path',
	        'div_id': 'set-entrypoint-path1'
	    })
	    load_list.push({
	        'id': 'entrypoint_path',
	        'div_id': 'summary-entrypoint-path1'
	    })
	
	    function getEntrypointPath(result_div_id){
	        input = {
	            'action':'action/get_entrypoint_path',
	            'window_id': WINDOW_ID,
	            'result_div_id': result_div_id
	        }
	        coreOnClick();
	        pywebview.api.call(input).then(showResponse).catch(showResponse)
	    }
	</script>


    <h2>Summary</h2>
    	
	<div class="hide">
	    <div class="flex-row">
	        <button onClick="getEntrypointPath('set-entrypoint-path2')">Select entrypoint note</button>
	        <div class="annotation" id="set-entrypoint-path2">None selected</div>
	        <div class="info-icon" onClick="toggle('info-select-entrypoint-path2')">i</div>
	    </div>
	    <div class="info-line" id="info-select-entrypoint-path2" style="display: none;">
	        The note that is to become the homepage of your new site. 
	        In default mode, ObsidianHtml will start compiling your website starting with this node, and following any links to any other note.
	        This note has to be in the vault selected above.
	    </div> 
	</div>
	
	<div class="">
	    <div class="flex-row">
	        <div class="spacer-2">Entrypoint</div>
	        <div class="spacer-4" id="summary-entrypoint-path2">Failed to load setting</div>
	        <div class="info-icon" onClick="toggle('info-summary-entrypoint-path2')">i</div>
	    </div>
	    <div class="info-line" id="info-summary-entrypoint-path2" style="display: none;">
	        The note that is to become the homepage of your new site. 
	        In default mode, ObsidianHtml will start compiling your website starting with this note, and following any links to any other note.
	        This note has to be in the vault selected above.
	    </div>
	</div>
	
	<script>
	    // register
	    load_list.push({
	        'id': 'entrypoint_path',
	        'div_id': 'set-entrypoint-path2'
	    })
	    load_list.push({
	        'id': 'entrypoint_path',
	        'div_id': 'summary-entrypoint-path2'
	    })
	
	    function getEntrypointPath(result_div_id){
	        input = {
	            'action':'action/get_entrypoint_path',
	            'window_id': WINDOW_ID,
	            'result_div_id': result_div_id
	        }
	        coreOnClick();
	        pywebview.api.call(input).then(showResponse).catch(showResponse)
	    }
	</script>


    <script>
        		// HTML Functions
		// -----------------------------------------------------------------------
		function toggle(id) {
		    let cont = document.getElementById(id)
		    if (cont.style.display == 'none') {
		        cont.style.display = 'block'
		    } else {
		        cont.style.display = 'none'
		    }
		}
		
		function set_form_status(done) {
		    let el = document.getElementById("exit-button")
		    if (el) {
		        if (done) {
		            el.classList.add("done");
		        } else {
		            el.classList.remove("done");
		        }
		    }
		}
		
		function span_wrap(msg, code) {
		    return '<span class="code-' + code + '">' + msg + '</span>'
		}
		
		// API
		// -----------------------------------------------------------------------
		function api(method, args, resultdiv_id) {
		    action = showResponseEnclosure(resultdiv_id)
		    pywebview.api.call(method, args).then(action).catch(action)
		}
		function showResponseEnclosure(resultdiv_id) {
		    return function(response) {
		        showResponse(response, resultdiv_id)
		    }
		}
		function showResponse(args) {
		    let is_error = false;
		
		    // The calling function should pass the result_div_id to the API function, which in turn is responsible
		    // for putting it in the args variable.
		    // Any terminating error will result in an args variable that only has the message attribute.
		    // In this case (and when the caller doesn't set the result_div_id), put the error in the error-box
		    let container = document.getElementById(args.result_div_id)
		    let error_list = document.getElementById('error-list') // contains only the error itself
		
		    if (container == null){
		        is_error = true;
		        container = error_list;
		        showErrorBox();
		    }
		
		    // Set result code if missing. The codes follow http result code conventions.
		    if (args.code == null){
		        code = 500
		    } else {
		        code = args.code
		    }
		
		    if (code != 200){
		        is_error = true;
		    }
		
		    // We always expect message to be present, as this is added even in the case of terminating errors.
		    // If it is not, we are doing something wrong.
		    if (args.message == null){
		        alert(args)
		        args.message = 'args.message was null';
		        is_error = true;
		    }
		
		    // set contents of div
		    let msg = '<span class="code-' + code + '">' + args.message + '</span>'
		    container.innerHTML = msg;
		
		    if (is_error){
		        showErrorBox(msg);
		    }
		
		    // Make sure the container is visible
		    container.style.display = 'block'
		
		    // Tag the container as errored so it doesn't get overwritten by AutoReload
		    container.is_error = is_error;
		
		    // reload values
		    AutoReload();
		}
		
		
		function coreOnPywebviewReady(){
		    var container = document.getElementById('pywebview-status')
		    container.innerHTML = '<span style="color:green">GUI initialized</span>'
		
		    // presets
		    AutoReload();
		}
		
		function coreOnClick(){
		    hideErrorBox();
		}
		
		function hideErrorBox(){
		    let error_container = document.getElementById('error-box');
		    if (error_container.classList.contains('hidden') == false){
		        error_container.classList.add('hidden');
		    }
		}
		function showErrorBox(msg){
		    let error_container = document.getElementById('error-box');
		    if (error_container.classList.contains('hidden')){
		        error_container.classList.remove('hidden');
		    }
		
		    // show error message if passed in
		    if (msg){
		        document.getElementById('error-list').innerHTML = msg;
		    }
		}
		
		function AutoReload(){
		    pywebview.api.read_ledger(load_list).then(handleAutoReload).catch(handleAutoReload)
		}
		
		function handleAutoReload(response) {
		    for (let i = 0; i < response.data.length; i++) {
		        let req = response.data[i]
		
		        // get container to put value in
		        let container = document.getElementById(req.div_id)       
		        if (!container){
		            showErrorBox(span_wrap('Div with id '+req.div_id+' was not found.', 500));
		        }
		        let val = req.value
		
		        if (val == '') {
		            val = span_wrap('Not configured', 0)
		        }
		
		        if (container.is_error == true){
		            container.is_error = false
		        }
		        else {
		            container.innerHTML = val
		        }
		    }
		}

        window.addEventListener('pywebviewready', function () {
            coreOnPywebviewReady();
        })

    </script>
</body>
</html>