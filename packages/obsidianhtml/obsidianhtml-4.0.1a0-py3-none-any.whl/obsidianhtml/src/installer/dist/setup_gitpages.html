<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="UTF-8">
    <style>
		body {
		    margin: 2rem;
		}
		
		h2 {
		    border-bottom: 1px solid #b3c0c8;
		}
		h3 {
		    border-bottom: 5px solid #f5f1ff;
		}        
		
		#footer {
		    margin-top: 4rem;
		    color: gray;
		    border-top: 2px solid #ddd;
		    text-align: center;
		}
		
		code {
		    color: green;
		}
		
		.info-icon {
		    float: right;
		    background-color: #3175f7;
		    width: 1.0rem;
		    height: 1rem;
		    padding: 0.1rem;
		    text-align: center;
		    padding-bottom: 0rem;
		    color: white;
		    font-weight: bold;
		    border-radius: 1rem;
		    line-height: 11pt;
		    cursor: pointer;
		}
		.info-line {
		    width: 100%;
		    background-color: whitesmoke;
		    padding: 1rem;
		    margin: 1rem;
		    margin-left: -1rem;
		    font-size: 10pt;
		}
		
		.optional {
		    margin: 1rem;
		    border: 1px dotted #375fd4;
		    padding: 1rem;
		    background-color: #e6efff;
		}
		
		.annotation {
		    margin: 0.3rem;
		    padding: 0.3rem;
		}
		  
		label {
		    margin-left: 0.3rem;
		    margin-right: 0.3rem;
		}
		
		.hide,
		.hidden {
		    display: none
		}
		
		.spacer-1 {
		    margin: 0rem;
		    padding:0rem;
		}
		.spacer-2 {
		    margin: 0rem;
		    padding:0rem;
		}
		.spacer-3 {
		    margin: 0rem;
		    padding:0rem;
		}
		.spacer-4 {
		    margin: 0rem;
		    padding:0rem;
		}
		.flex-row {
		    display: flex;
		    flex-direction: row;
		    margin-bottom: 0.5rem;
		}
		.flex-row>.annotation {
		    flex: 4;
		}
		.flex-row>div.label {
		    flex: 1;
		}
		.flex-row>.spacer-1 {
		    flex: 1;
		}  
		.flex-row>.spacer-2 {
		    flex: 2;
		}  
		.flex-row>.spacer-3 {
		    flex: 3;
		}  
		.flex-row>.spacer-4 {
		    flex: 4;
		}                                
		.flex-row>input {
		    flex: auto;
		}        
		.flex-row>button {
		    flex: 1;
		} 
		#pywebview-status {
		    position: absolute;
		    top: 0rem;
		    right: 1rem;
		}
		
		#response-container {
		    display: none;
		    padding: 3rem;
		    margin: 3rem 5rem;
		    font-size: 12pt;
		    border: 5px dashed #ccc;
		}
		
		.code-0 {
		    color: gray
		}
		
		.code-405 {
		    color: rgb(237, 10, 10);
		
		}
		
		.code-500 {
		    color: rgb(237, 10, 10);
		    font-weight: bold;
		}
		
		.code-500::before {
		    content: 'Internal Error: ';
		}
		
		.blink_me {
		    animation: blinker 1s linear infinite;
		}
		
		@keyframes blinker {
		    50% {
		        opacity: 0;
		        color: rgb(237, 10, 10);
		    }
		}
		
		.done {
		    background-color: #e9ffdf;
		    color: #14440a;
		    border: 1px dotted #248a07;
		}
		.action-link {
		    color: blue;
		    text-decoration: underline;
		    cursor: pointer;
		}
		
		button {
		    font-size: 10pt;
		    margin: 0.3rem;
		    background-color: #0a365d;
		    border: 0px solid #fff;
		    color: white;
		    font-weight: normal;
		    border-radius: 0.4rem;
		    cursor: pointer;
		}
		.bottom {
		    margin-left: -2rem;
		    width: calc(100vw);
		    position: fixed;
		    bottom: -0.3rem;
		    border-top: 1px solid #9090a4;
		}    
		
		#footer button {
		    padding: 1rem;
		    display: block;
		    width: 100%;
		    border-radius: 0;
		    padding-top: 0.3rem;
		    padding-bottom: 0.3rem;
		    background-color: #c8c8d9;
		    color: #191d59;
		}
		#footer button.bottom {
		    padding: 0.5rem;
		}
		
		#footer button.done {
		    background-color: #e0eeb9;
		    color: #14440a;
		}
		div.done button {
		    background-color: #bae5ab;
		    color: #14440a;
		}
		
		
		#error-box {
		    width: 100vw;
		    background-color: #090909d1;
		    position: absolute;
		    top: 80vh;
		    left: 0;
		    height: 20vh;
		    overflow-y: scroll;
		}
		.close-error-box {
		    width: 16px;
		    float: right;
		    font-family: sans;
		    color: white;
		    cursor: pointer;
		    font-size: 10pt;
		    border: 1px solid white;
		    text-align: center;
		}
		#error-list {
		    margin: 1rem;
		    color: white;
		    font-family: sans;
		    font-size: 10pt;
		}
		

	</style>
    <script>
        let WINDOW_ID = 'setup_gitpages'
    </script>    
</head>

<body>
    <div id="outnull"></div>
    <p id='pywebview-status'><span class="blink_me">Initializing...</span></p>

    <h1>Setup Gitpages</h1>
    <p>For this step you need to do three things:</p>
    <ul>
        <li>Create a github account (if you don't have one yet)</li>
        <li>Install Git on your system</li>
        <li>Create a new repository named exactly '(your username).github.io'</li>
        <li>Clone the repository locally</li>
    </ul>
    <p>
        You can do this yourself, the 
        <a class="external-link" onclick="api('openUrlInDefaultBrowser', {'url':'https://pages.github.com/'},'outnull')">
            gitpages documentation
        </a> is pretty good
    </p>

    <p>If you succeed in doing this manually, you can close this window and continue with the installer setup. 
        Otherwise, you can continue below. Make sure that you have at least 
        <a class="external-link" onclick="api('openUrlInDefaultBrowser', {'url':'https://github.com/signup'},'outnull')">
            a github account
        </a> before you continue below.
    </p>

    <!--    ---------------------------------------------------------------------- -->    

 
    <h2>Configure Repo</h2>
    <div class="flex-row">
        <label for="github-username">Github username: </label>
        <input id="github-username" type="text" />
        <div class="spacer-1">&nbsp;</div>
    </div>
    <div class="flex-row">
        <button class="action" onClick="CheckGithubUsername('github-username')">Check</button><br/>
        <div class="spacer-4">&nbsp;</div>
    </div>    

    <div class="annotation" id="output-github-username-check"></div>

    <!--    ---------------------------------------------------------------------- -->
    <div id="step-1" style="display: none;">
        <h2>Check prequisites</h2>
        <p>In this step we will test if Git is installed and whether it is configured correctly.</p>
        <div class="flex-row">
            <button class="action" onClick="CheckGit('output-git-check')">Check Prerequisites</button><br/>
            <div class="spacer-4">&nbsp;</div>
        </div>

        <div class="annotation" id="output-git-check"></div>

        <div id="step-install-git"  style="display: none;">
            <h3>Install Git</h3>
            <p>Git was not found on your system. Follow one of the following links to install Git on your system.</p>
            <ul>
                <li><b>Linux: </b> 
                    <a class="external-link" onclick="api('openUrlInDefaultBrowser', {'url':'https://git-scm.com/download/linux'},'outnull')">
                        https://git-scm.com/download/linux
                    </a>
                </li>
                <li><b>macOS: </b>
                    <a class="external-link" onclick="api('openUrlInDefaultBrowser', {'url':'https://git-scm.com/download/mac'},'outnull')">
                        https://git-scm.com/download/mac
                    </a>
                </li>
                <li><b>Windows: </b>
                    <a class="external-link" onclick="api('openUrlInDefaultBrowser', {'url':'https://gitforwindows.org/'},'outnull')">
                        https://gitforwindows.org/
                    </a> <br/><i>(When in doubt: pick Git Bash and install with default settings.)</i>
                </li>
            </ul>
            <p class="hint">Run check again after a successful installation.</p>
        </div>

        <div id="step-set-username"  style="display: none;">
            <h3>Set git user.name</h3>
            <p>No username setting was found in your global settings.</p>
            <div class="aside">
                This installer will work with local settings, but in that case you must skip this sub-installer 
                and do the git repo creation and git clone steps manually.
            </div>

            <div class="flex-row">
                <div class="spacer-4">
                    <label for="github-username">Github user.name: </label> <br/>
                    <input class="input_left" id="github-set-username" type="text" />
                </div>
                <div class="annotation" id="output-github-username-set"></div>
            </div>
            <div class="flex-row">
                <button class="action" onClick="SetGithubUsername('github-set-username', 'output-github-username-set')">Set</button>
                <div class="spacer-4">&nbsp;</div>
            </div>
            <p class="hint">Run check again after a successful set.</p>
        </div>

        <div id="step-set-email"  style="display: none;">
            <h3>Set git user.email</h3>
            <p>No username setting was found in your global settings.</p>
            <div class="aside">
                This installer will work with local settings, but in that case you must skip this sub-installer 
                and do the git repo creation and git clone steps manually.
            </div>

            <div class="flex-row">
                <div class="spacer-4">
                    <label for="github-set-email">Github user.email: </label><br/>
                    <input class="input_left" id="github-set-email" type="text" />
                </div>
                <div class="annotation" id="output-github-email-set"></div>
            </div>
            <div class="flex-row">
                <button class="action" onClick="SetGithubEmail('github-set-email', 'output-github-email-set')">Set</button>
                <div class="spacer-4">&nbsp;</div>
            </div>
            <p class="hint">Run check again after a successful set.</p>
        </div>
    </div>


    <!--    ---------------------------------------------------------------------- -->

    <div id="step-2" style="display: none;">
        <h2>Choose where to clone your repo to</h2>
        <div class="flex-row">
            <button onClick="api('getRepoPath', {'window_id': WINDOW_ID}, 'annotation-setup-repo')">Set clone location</button><br/>
            <div class="annotation" id="annotation-setup-repo">&nbsp;</div>
        </div>

        <h2>Clone</h2>
        <p>This step will clone the configured repo to the configured local folder.</p>

        <p>Please first run the pre-clone check to guarantee that all the values are populated correctly in the backend.</p>
        <div class="flex-row">
            <button class="action" onClick="CheckCloneRepo('response-clone')">Check</button><br/>
            <div class="spacer-4">&nbsp;</div>
        </div>
        <div id="response-clone"></div>
        <div class="flex-row">
            <button class="action" onClick="CloneRepo('response-clone')">Clone</button><br/>
            <div class="spacer-4">&nbsp;</div>
        </div>
    </div>

    

    <!--    ---------------------------------------------------------------------- -->
    <div id="step-3" style="display: none;">
        <h2>Done setting up git pages</h2>
        <p>All local settings are ready to start publishing to your own gitpage. We haven't created the website yet, but we can continue in the main installation wizard with getting you set up for that.</p>
        <p>Close this window and continue in the main installer to complete setting up gitpage publishing.</p>
    </div>

    <!--    ---------------------------------------------------------------------- -->

    <div id="footer" style="border: none;">
        <button class="action bottom" id="exit-button" onClick="api('close', {'window_id': WINDOW_ID}, 'outnull')">Close</button>
    </div>
    
    <script>
		// HTML Functions
		// -----------------------------------------------------------------------
		function toggle(id) {
		    let cont = document.getElementById(id)
		    if (cont.style.display == 'none') {
		        cont.style.display = 'block'
		    } else {
		        cont.style.display = 'none'
		    }
		}
		
		function set_form_status(done) {
		    let el = document.getElementById("exit-button")
		    if (el) {
		        if (done) {
		            el.classList.add("done");
		        } else {
		            el.classList.remove("done");
		        }
		    }
		}
		
		function span_wrap(msg, code) {
		    return '<span class="code-' + code + '">' + msg + '</span>'
		}
		
		// API
		// -----------------------------------------------------------------------
		function api(method, args, resultdiv_id) {
		    action = showResponseEnclosure(resultdiv_id)
		    pywebview.api.call(method, args).then(action).catch(action)
		}
		function showResponseEnclosure(resultdiv_id) {
		    return function(response) {
		        showResponse(response, resultdiv_id)
		    }
		}
		function showResponse(args) {
		    let is_error = false;
		
		    // The calling function should pass the result_div_id to the API function, which in turn is responsible
		    // for putting it in the args variable.
		    // Any terminating error will result in an args variable that only has the message attribute.
		    // In this case (and when the caller doesn't set the result_div_id), put the error in the error-box
		    let container = document.getElementById(args.result_div_id)
		    let error_list = document.getElementById('error-list') // contains only the error itself
		
		    if (container == null){
		        is_error = true;
		        container = error_list;
		        showErrorBox();
		    }
		
		    // Set result code if missing. The codes follow http result code conventions.
		    if (args.code == null){
		        code = 500
		    } else {
		        code = args.code
		    }
		
		    if (code != 200){
		        is_error = true;
		    }
		
		    // We always expect message to be present, as this is added even in the case of terminating errors.
		    // If it is not, we are doing something wrong.
		    if (args.message == null){
		        alert(args)
		        args.message = 'args.message was null';
		        is_error = true;
		    }
		
		    // set contents of div
		    let msg = '<span class="code-' + code + '">' + args.message + '</span>'
		    container.innerHTML = msg;
		
		    if (is_error){
		        showErrorBox(msg);
		    }
		
		    // Make sure the container is visible
		    container.style.display = 'block'
		
		    // Tag the container as errored so it doesn't get overwritten by AutoReload
		    container.is_error = is_error;
		
		    // reload values
		    AutoReload();
		}
		
		
		function coreOnPywebviewReady(){
		    var container = document.getElementById('pywebview-status')
		    container.innerHTML = '<span style="color:green">GUI initialized</span>'
		
		    // presets
		    AutoReload();
		}
		
		function coreOnClick(){
		    hideErrorBox();
		}
		
		function hideErrorBox(){
		    let error_container = document.getElementById('error-box');
		    if (error_container.classList.contains('hidden') == false){
		        error_container.classList.add('hidden');
		    }
		}
		function showErrorBox(msg){
		    let error_container = document.getElementById('error-box');
		    if (error_container.classList.contains('hidden')){
		        error_container.classList.remove('hidden');
		    }
		
		    // show error message if passed in
		    if (msg){
		        document.getElementById('error-list').innerHTML = msg;
		    }
		}
		
		function AutoReload(){
		    pywebview.api.read_ledger(load_list).then(handleAutoReload).catch(handleAutoReload)
		}
		
		function handleAutoReload(response) {
		    for (let i = 0; i < response.data.length; i++) {
		        let req = response.data[i]
		
		        // get container to put value in
		        let container = document.getElementById(req.div_id)       
		        if (!container){
		            showErrorBox(span_wrap('Div with id '+req.div_id+' was not found.', 500));
		        }
		        let val = req.value
		
		        if (val == '') {
		            val = span_wrap('Not configured', 0)
		        }
		
		        if (container.is_error == true){
		            container.is_error = false
		        }
		        else {
		            container.innerHTML = val
		        }
		    }
		}


        // On load
        // -----------------------------------------------------------------------
        window.addEventListener('pywebviewready', function() {
            var container = document.getElementById('pywebview-status')
            container.innerHTML = '<span style="color:green">GUI initialized</span>'

            // presets
            api('presetConfigPath', {}, 'annotation-config-path')
        })

        // Page specific
        // -----------------------------------------------------------------------
        function updateInput(elementId) {
            return function(response) {
                var element = document.getElementById(elementId)

                if (response.code == 200){
                    element.style.backgroundColor = 'green'
                } else {
                    element.style.backgroundColor = 'red'
                    alert(response.message)
                }
            }
        }

        function alertError(input_id){
            return function(response) {
                document.getElementById(input_id).style.backgroundColor = 'red'
                alert(response.message)
            }
        }

        function choose_optional_setup_gitpages(enable, disable){
            document.getElementById(enable).style.display = 'block';
            document.getElementById(disable).style.display = 'none';
        }

        function CheckGithubUsername(input_id){
            // hide next steps
            document.getElementById('step-1').style.display = 'none'
            document.getElementById('output-git-check').style.display = 'none'
            document.getElementById('step-2').style.display = 'none'

            input_el = document.getElementById(input_id)
            input_el.style.backgroundColor = 'orange'
            username = input_el.value
            if (username == ''){
                alert('Please type in your username')
                return
            }

            action = function(response){
                fn = updateInput(input_id)
                fn(response)

                CheckGithubUsernameOutput(response)
            }

            catch_action = alertError(input_id)
            pywebview.api.call('CheckGithubUsername', {'username':username}).then(action).catch(catch_action)
        }

        function CheckGithubUsernameOutput(response){
            div = document.getElementById('output-github-username-check')

            if (response.code != 200){
                div.style.display = 'none'
            }
            else {
                // Fill in field for setting git global config
                PresetGithubUsername(response.data.username)

                // Give feedback to user
                div.style.display = 'block'
                if (response.data.repo_exists == true){
                    html = 'Your github page repository name is '
                    html += '<a class="external-link" onclick="api(\'openUrlInDefaultBrowser\', {\'url\':\''+response.data.repo_url+'\'},\'outnull\')">'+response.data.repo_name+'</a>. '
                    html += '<br/><br/><b>Note</b>: if you continue with this installer, the contents of this repo will be completely replaced!'
                    div.innerHTML = html

                    // Try to determine optimal clone location based on repo name
                    api('presetRepoClonePath', {'repo_name': response.data.repo_name}, 'annotation-setup-repo')

                    // Enable next steps
                    document.getElementById('step-1').style.display = 'block'
                }
                else {
                    // Username valid, but repo not created
                    html = '<p>Your github page repository name is <code>'+response.data.repo_name+'</code>.</p><p>It does not yet exist.<p>'
                    html += '<p>Go here <a class="external-link" onclick="api(\'openUrlInDefaultBrowser\', {\'url\':\'https://github.com/new\'},\'outnull\')">https://github.com/new</a> and fill in the following settings: '
                    html += '<ul><li><b>Repository name</b>: <input value="'+response.data.repo_name+'" /></li><li>Leave all the rest on default!</li><li>Click on <b>Create Repository</b></li></ul></p>'
                    html += '<p>When done, click check again.</p>' 
                    div.innerHTML = html
                }
            }
        }

        function CheckGit(resultdiv_id){
            // hide next steps
            document.getElementById('step-2').style.display = 'none'

            // hide correction divs
            document.getElementById('step-set-username').style.display = 'none'
            document.getElementById('step-set-email').style.display = 'none'
            document.getElementById('step-install-git').style.display = 'none'
                    
            action = CheckGitOutputEnclosure(resultdiv_id)
            pywebview.api.call('CheckGit').then(action).catch(action)            
        }
        function CheckGitOutputEnclosure (resultdiv_id) {
            return function (response) {
                showResponse(response, resultdiv_id)
                window.scrollBy(0, 100);
                CheckGitOutput(response, resultdiv_id)
            }
        }
        function CheckGitOutput(response, resultdiv_id) {
            let ok = true
            for (let i = 0; i < response.data.length; i++) {
                if (response.data[i]['name'] == 'git_username_not_configured') {
                    document.getElementById('step-set-username').style.display = 'block'
                    ok = false
                }
                else if (response.data[i]['name'] == 'git_email_not_configured') {
                    document.getElementById('step-set-email').style.display = 'block'
                    ok = false
                }
                else if (response.data[i]['name'] == 'git_not_installed') {
                    document.getElementById('step-install-git').style.display = 'block'
                    ok = false
                } 
            }

            if (ok) {
                // Enable next steps
                document.getElementById('step-2').style.display = 'block'
            }
        }

        function PresetGithubUsername(username){
            document.getElementById("github-set-username").value = username
        }
        function SetGithubUsername(input_id, resultdiv_id){
            username = document.getElementById(input_id).value

            action = showResponseEnclosure(resultdiv_id)
            pywebview.api.call('SetGitUsername', {'username':username}).then(action).catch(action)
        }

        function SetGithubEmail(input_id, resultdiv_id){
            email = document.getElementById(input_id).value

            action = showResponseEnclosure(resultdiv_id)
            pywebview.api.call('SetGitEmail', {'email':email}).then(action).catch(action)
        }        
        
        function CheckCloneRepo(resultdiv_id){
            action = CheckCloneRepoOutputEnclosure(resultdiv_id)
            pywebview.api.call('FlightCheckCloneRepo').then(action).catch(action)
        }    
        
        function CheckCloneRepoOutputEnclosure(resultdiv_id){
            return function (response) {
                showResponse(response, resultdiv_id)
                CheckCloneRepoOutput(response, resultdiv_id)
            }
        }
        function CheckCloneRepoOutput(response, resultdiv_id){
            if (response.data.ready){
                document.getElementById('step-3').style.display = 'block'
                set_form_status(true)
            } else {
                document.getElementById('step-3').style.display = 'none'
            }
        }
        function CloneRepo(resultdiv_id){
            action = CheckCloneRepoOutputEnclosure(resultdiv_id)
            pywebview.api.call('CloneRepo').then(action).catch(action)
        }



    </script>
</body>

</html>