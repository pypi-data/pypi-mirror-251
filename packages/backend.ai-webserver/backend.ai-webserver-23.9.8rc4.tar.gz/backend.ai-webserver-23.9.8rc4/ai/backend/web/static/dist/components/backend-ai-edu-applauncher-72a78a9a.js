import{_ as e,n as i,b as t,e as s,B as n,c as o,I as a,a as c,q as r,d as l,i as p,ar as h,as as u,g as d,f as g,x as f}from"./backend-ai-webui-951d3157.js";let b=class extends n{constructor(){super(...arguments),this.webUIShell=Object(),this.clientConfig=Object(),this.client=Object(),this.notification=Object(),this.resources=Object(),this._eduAppNamePrefix=""}static get styles(){return[o,a,c,r,l,p``]}firstUpdated(){this.notification=globalThis.lablupNotification}detectIE(){try{return!!!!document.documentMode||(navigator.userAgent.indexOf("MSIE")>0||navigator.userAgent.indexOf("WOW")>0||navigator.userAgent.indexOf(".NET")>0)}catch(e){const i=e.toString();return console.log(i),!1}}async prepareProjectInformation(){const e=`query { user{ ${["email","groups {name, id}"].join(" ")} } }`,i=await globalThis.backendaiclient.query(e,{});globalThis.backendaiclient.groups=i.user.groups.map((e=>e.name)).sort(),globalThis.backendaiclient.groupIds=i.user.groups.reduce(((e,i)=>(e[i.name]=i.id,e)),{});const t=globalThis.backendaiutils._readRecentProjectGroup();globalThis.backendaiclient.current_group=t||globalThis.backendaiclient.groups[0],globalThis.backendaiclient.current_group_id=()=>globalThis.backendaiclient.groupIds[globalThis.backendaiclient.current_group],console.log("current project:",t)}async launch(e){await this._initClient(e);const i=new URLSearchParams(window.location.search);this.resources={cpu:i.get("cpu"),mem:i.get("mem"),shmem:i.get("shmem"),"cuda.shares":i.get("cuda-shares"),"cuda.device":i.get("cuda-device")};if(await this._token_login()){await this.prepareProjectInformation();const e=window.location.search,i=new URLSearchParams(e),t=i.get("session_id")||null;if(t){const e=i.get("app")||"jupyter";this._openServiceApp(t,e)}else await this._createEduSession()}}async _initClient(e){this.notification=globalThis.lablupNotification;const i=document.querySelector("#webui-shell");if(""===e){const i=localStorage.getItem("backendaiwebui.api_endpoint");null!=i&&(e=i.replace(/^"+|"+$/g,""))}e=e.trim(),this.clientConfig=new h("","",e,"SESSION"),globalThis.backendaiclient=new u(this.clientConfig,"Backend.AI Web UI.");await i._parseConfig("../../config.toml"),globalThis.backendaiclient._config._proxyURL=i.config.wsproxy.proxyURL,await globalThis.backendaiclient.get_manager_version(),globalThis.backendaiclient.ready=!0}async _token_login(){const e=window.location.search,i=new URLSearchParams(e),t=i.get("sToken")||i.get("stoken")||null;null!==t&&(document.cookie=`sToken=${t}; expires=Session; path=/`);const s={};for(const[e,t]of i.entries())"sToken"!==e&&"stoken"!==e&&(s[e]=t);try{if(await globalThis.backendaiclient.check_login())console.log("already logged-in session");else{console.log("logging with (cookie) token...");if(!await globalThis.backendaiclient.token_login(t,s))return this.notification.text=d("eduapi.CannotAuthorizeSessionByToken"),this.notification.show(!0),!1}return!0}catch(e){return this.notification.text=d("eduapi.CannotAuthorizeSessionByToken"),this.notification.show(!0,e),!1}}generateSessionId(){let e="";const i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let t=0;t<8;t++)e+=i.charAt(Math.floor(62*Math.random()));return e+"-session"}async _createEduSession(){this.appLauncher.indicator=await globalThis.lablupIndicator.start(),this._eduAppNamePrefix=globalThis.backendaiclient._config.eduAppNamePrefix;const e=["session_id","name","access_key","status","status_info","service_ports","mounts"];let i;i=globalThis.backendaiclient.supports("avoid-hol-blocking")?["RUNNING","RESTARTING","TERMINATING","PENDING","SCHEDULED","PREPARING","PULLING"].join(","):["RUNNING","RESTARTING","TERMINATING","PENDING","PREPARING","PULLING"].join(",");const t=globalThis.backendaiclient._config.accessKey;let s;try{this.appLauncher.indicator.set(20,d("eduapi.QueryingExisitingComputeSession")),s=await globalThis.backendaiclient.computeSession.list(e,i,t,30,0)}catch(e){return console.error(e),void(e&&e.message?(e.description?this.notification.text=g.relieve(e.description):this.notification.text=g.relieve(e.message),this.notification.detail=e.message,this.notification.show(!0,e)):e&&e.title&&(this.notification.text=g.relieve(e.title),this.notification.show(!0,e)))}const n=window.location.search,o=new URLSearchParams(n);let a,c=o.get("app")||"jupyter",r=!0;if(s.compute_session_list.total_count>0){console.log("Reusing an existing session ...");const e=s.compute_session_list.items[0].status;if("RUNNING"!==e)return this.notification.text=d("eduapi.sessionStatusIs")+` ${e}. `+d("eduapi.PleaseReload"),void this.notification.show(!0);let i=null;for(let e=0;e<s.compute_session_list.items.length;e++){const t=s.compute_session_list.items[e],n=JSON.parse(t.service_ports||"{}").map((e=>e.name));let o=c;if(""!==this._eduAppNamePrefix&&c.startsWith(this._eduAppNamePrefix)&&(o=c.split("-")[1]),n.includes(o)){i=t;break}}i?(r=!1,a="session_id"in i?i.session_id:null,this.appLauncher.indicator.set(50,d("eduapi.FoundExistingComputeSession"))):r=!0,a=null!==i&&"session_id"in i?i.session_id:null}if(r){let e;console.log("Creating a new session ..."),this.appLauncher.indicator.set(40,d("eduapi.FindingSessionTemplate"));try{e=await globalThis.backendaiclient.sessionTemplate.list(!1)}catch(e){return console.error(e),void(e&&e.message?(e.description?this.notification.text=g.relieve(e.description):this.notification.text=g.relieve(e.message),this.notification.detail=e.message,this.notification.show(!0,e)):e&&e.title&&(this.notification.text=g.relieve(e.title),this.notification.show(!0,e)))}if(e=e.filter((e=>e.name===c)),e.length<1)return this.notification.text=d("eduapi.NoSessionTemplate"),void this.notification.show(!0);const i=e[0].id;try{const e=await globalThis.backendaiclient.eduApp.get_mount_folders(),t=await globalThis.backendaiclient.eduApp.get_user_projects();if(!t)return this.notification.text=d("eduapi.EmptyProject"),void this.notification.show();const s=o.get("sToken")||o.get("stoken"),n=s?(await globalThis.backendaiclient.eduApp.get_user_credential(s)).script:void 0,c={...this.resources,group_name:t[0].name,...e&&Object.keys(e).length>0?{mounts:e}:{},...n?{bootstrap_script:n}:{}};let r;try{this.appLauncher.indicator.set(60,d("eduapi.CreatingComputeSession")),r=await globalThis.backendaiclient.createSessionFromTemplate(i,null,null,c,2e4)}catch(e){return console.error(e),void(e&&e.message?(e.description?this.notification.text=g.relieve(e.description):this.notification.text=g.relieve(e.message),this.notification.detail=e.message,this.notification.show(!0,e)):e&&e.title&&(this.notification.text=g.relieve(e.title),this.notification.show(!0,e)))}a=r.sessionId}catch(e){console.error(e),e&&e.message?("statusCode"in e&&408===e.statusCode?this.notification.text=d("eduapi.SessionStillPreparing"):e.description?this.notification.text=g.relieve(e.description):this.notification.text=g.relieve(e.message),this.notification.detail=e.message,this.notification.show(!0,e)):e&&e.title&&(this.notification.text=g.relieve(e.title),this.notification.show(!0,e))}}this.appLauncher.indicator.set(100,d("eduapi.ComputeSessionPrepared")),a&&this._openServiceApp(a,c)}async _openServiceApp(e,i){this.appLauncher.indicator=await globalThis.lablupIndicator.start();let t=i;this.detectIE()||(""!==this._eduAppNamePrefix&&i.startsWith(this._eduAppNamePrefix)&&(t=i.split("-")[1]),i.startsWith("jupyter")&&(t="jupyterlab")),console.log(`launching ${t} from session ${e} ...`),this.appLauncher._open_wsproxy(e,t,null,null).then((async e=>{if(e.url){i.endsWith("rstudio")&&await this.appLauncher._sleep(1e4);const t=await this.appLauncher._connectToProxyWorker(e.url,"");this.appLauncher.indicator.set(100,d("session.applauncher.Prepared")),setTimeout((()=>{globalThis.open(t||e.url,"_self")}))}}))}render(){return f`
      <backend-ai-app-launcher id="app-launcher"></backend-ai-app-launcher>
    `}};e([i({type:Object})],b.prototype,"webUIShell",void 0),e([i({type:Object})],b.prototype,"clientConfig",void 0),e([i({type:Object})],b.prototype,"client",void 0),e([i({type:Object})],b.prototype,"notification",void 0),e([i({type:String})],b.prototype,"resources",void 0),e([i({type:String})],b.prototype,"_eduAppNamePrefix",void 0),e([t("#app-launcher")],b.prototype,"appLauncher",void 0),b=e([s("backend-ai-edu-applauncher")],b);
